<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>K&T Nails - Receipt Scanner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
      :root {
        --primary: #ec4899;
        --primary-dark: #db2777;
        --secondary: #f472b6;
        --background: #f8fafc;
        --card-bg: #ffffff;
        --text-main: #0f172a;
        --text-muted: #64748b;
        --border: #e2e8f0;
        --sidebar-bg: #f8fafc;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background);
        color: var(--text-main);
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar Copy */
      .sidebar {
        width: 280px;
        background: var(--sidebar-bg);
        padding: 32px 24px;
        position: fixed;
        height: 100vh;
        border-right: 1px solid var(--border);
      }
      .logo-section {
        text-align: center;
        margin-bottom: 32px;
      }
      .logo-section img {
        width: 120px;
        border-radius: 12px;
        margin-bottom: 16px;
      }
      .nav-menu {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .nav-item {
        padding: 14px 20px;
        border-radius: 12px;
        color: var(--text-muted);
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .nav-item:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--primary);
      }
      .nav-item.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
      }

      .main-content {
        margin-left: 280px;
        padding: 40px;
        flex: 1;
      }
      .header {
        margin-bottom: 32px;
      }
      .header h1 {
        font-size: 28px;
        font-weight: 800;
      }

      /* Scanner Specific */
      .camera-card {
        background: white;
        border-radius: 24px;
        padding: 32px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        max-width: 600px;
        margin: 0 auto;
      }
      .camera-view {
        width: 100%;
        aspect-ratio: 3/4;
        background: #000;
        border-radius: 16px;
        overflow: hidden;
        position: relative;
      }
      #video {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .scanner-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--primary);
        box-shadow: 0 0 15px var(--primary);
        animation: scan 3s linear infinite;
      }
      @keyframes scan {
        0% {
          top: 0%;
        }
        50% {
          top: 100%;
        }
        100% {
          top: 0%;
        }
      }

      .controls {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-top: 24px;
      }
      .capture-btn {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 4px solid var(--primary);
        background: transparent;
        padding: 5px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .capture-btn:active {
        transform: scale(0.9);
      }
      .capture-btn .inner {
        width: 100%;
        height: 100%;
        background: var(--primary);
        border-radius: 50%;
      }

      .preview-container {
        text-align: center;
        display: none;
      }
      #capturedImg {
        width: 100%;
        border-radius: 16px;
        margin: 20px 0;
      }
      .btn-group {
        display: flex;
        gap: 12px;
        width: 100%;
      }
      .btn {
        flex: 1;
        padding: 14px;
        border-radius: 12px;
        border: none;
        font-weight: 700;
        cursor: pointer;
        font-size: 16px;
        transition: 0.2s;
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-secondary {
        background: #f1f5f9;
        color: var(--text-main);
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 100;
        backdrop-filter: blur(8px);
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #eee;
        border-top: 5px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
      }
      @keyframes spin {
        100% {
          transform: rotate(360deg);
        }
      }

      .result-card {
        background: #f0fdf4;
        border: 1px solid #bbf7d0;
        padding: 20px;
        border-radius: 16px;
        margin-top: 24px;
        display: none;
      }
      .result-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
      }
      .result-label {
        font-weight: 600;
        color: #166534;
      }
      .result-value {
        font-weight: 800;
        color: #15803d;
      }

      @media (max-width: 768px) {
        .sidebar {
          display: none;
        }
        .main-content {
          margin-left: 0;
          padding: 20px;
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
      <div class="logo-section">
        <img src="kntlogo2026.png" alt="K&T Nails" />
        <h2>K&T NAILS</h2>
      </div>
        <nav class="nav-menu">
          <a href="index.html" class="nav-item">üè† Dashboard</a>
          <a href="dashboard.html" class="nav-item">üí∞ Enter Sales</a>
          <a href="business-budget.html" class="nav-item">üìà Budget</a>
          <a href="receipt-list.html" class="nav-item">üìã Business Receipts</a>
          <a href="receipt-scanner.html" class="nav-item active">üì∏ Receipt Scanner</a>
        </nav>
    </div>

    <main class="main-content">
      <div class="header">
        <h1>Receipt Scanner</h1>
        <p>Snap a photo of any business expense receipt</p>
      </div>

      <div class="camera-card" id="cameraCard">
        <div class="camera-view">
          <video id="video" autoplay playsinline></video>
          <div class="scanner-line"></div>
        </div>
        <div class="controls">
          <button class="capture-btn" id="captureBtn">
            <div class="inner"></div>
          </button>
          <p
            style="font-weight: 600; font-size: 14px; color: var(--text-muted)"
          >
            TAP TO CAPTURE
          </p>
          <p style="margin: 10px 0; color: var(--text-muted); font-weight: 600;">OR</p>
          <label for="fileUpload" class="btn btn-secondary" style="cursor: pointer; display: inline-block; text-align: center;">
            üìÅ Upload from Gallery
          </label>
          <input type="file" id="fileUpload" accept="image/*" style="display: none;">
        </div>
      </div>

      <div class="camera-card preview-container" id="previewContainer">
        <h3>Review Receipt</h3>
        <img id="capturedImg" />
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="retake()">Retake</button>
          <button class="btn btn-primary" onclick="process()">
            Process with AI
          </button>
        </div>
      </div>

      <div
        class="result-card"
        id="resultCard"
        style="background: white; border: 1px solid var(--border)"
      >
        <h3 style="margin-bottom: 20px; color: var(--primary)">Scan Results</h3>
        <div class="result-row">
          <span class="result-label">Date:</span>
          <input
            type="text"
            id="resDate"
            class="btn"
            style="
              background: #f8fafc;
              text-align: right;
              width: auto;
              flex: 1;
              padding: 4px 8px;
              font-size: 14px;
            "
          />
        </div>
        <div class="result-row">
          <span class="result-label">Category:</span>
          <select
            id="resType"
            class="btn"
            style="
              background: #f8fafc;
              text-align: right;
              width: auto;
              flex: 1;
              padding: 4px 8px;
              font-size: 14px;
            "
          >
            <!-- Utilities -->
            <optgroup label="Utilities">
              <option value="Electricity & Gas">Electricity & Gas</option>
              <option value="Water & Waste">Water & Waste</option>
              <option value="Internet & Phone">Internet & Phone</option>
            </optgroup>
            <!-- Marketing -->
            <optgroup label="Marketing">
              <option value="Advertising">Advertising</option>
              <option value="Software / Subscriptions">Software / Subscriptions</option>
            </optgroup>
            <!-- Admin / Bank -->
            <optgroup label="Admin / Bank">
              <option value="Merchant Fees">Merchant Fees</option>
              <option value="Bank Service Charges">Bank Service Charges</option>
            </optgroup>
             <!-- Professional -->
            <optgroup label="Professional">
              <option value="Accounting & Legal">Accounting & Legal</option>
              <option value="Dues & Subscriptions">Dues & Subscriptions</option>
              <option value="quickbook">quickbook</option>
            </optgroup>
             <!-- Travel / Auto -->
            <optgroup label="Travel / Auto">
              <option value="Business Meals">Business Meals</option>
              <option value="Auto / Mileage">Auto / Mileage</option>
            </optgroup>
             <!-- Employee Costs -->
            <optgroup label="Employee Costs">
              <option value="Wages">Wages</option>
              <option value="Supply">Supply</option>
              <option value="Other">Other</option>
            </optgroup>
          </select>
        </div>
        <div class="result-row">
          <span class="result-label">Company/Store:</span>
          <input
            type="text"
            id="resMerchant"
            class="btn"
            style="
              background: #f8fafc;
              text-align: right;
              width: auto;
              flex: 1;
              padding: 4px 8px;
              font-size: 14px;
            "
          />
        </div>
        <div class="result-row">
          <span class="result-label">Items:</span>
          <textarea
            id="resItems"
            class="btn"
            style="
              background: #f8fafc;
              text-align: right;
              width: auto;
              flex: 1;
              padding: 4px 8px;
              font-size: 14px;
              min-height: 60px;
              font-family: inherit;
            "
          ></textarea>
        </div>
        <div
          class="result-row"
          style="margin-top: 12px; border-top: 2px solid #f1f5f9; padding-top: 12px"
        >
          <span class="result-label" style="font-size: 18px">Total:</span>
          <input
            type="text"
            id="resTotal"
            class="btn"
            style="
              background: #f1f5f9;
              text-align: right;
              width: auto;
              flex: 1;
              padding: 8px;
              font-size: 20px;
              font-weight: 800;
              color: var(--primary);
            "
          />
        </div>
        <div class="btn-group" style="margin-top: 20px">
          <button class="btn btn-secondary" onclick="retake()">Discard</button>
          <button class="btn btn-primary" onclick="saveToBudget()">
            Confirm & Save
          </button>
        </div>
      </div>
      </div>

      <div class="camera-card" id="manualEntryCard" style="margin-top: 32px;">
        <h3 style="margin-bottom: 20px; color: var(--text-main)">üìù Manual Entry</h3>
        
        <div class="result-row">
            <span class="result-label">Date:</span>
            <input type="date" id="manDate" class="btn" style="text-align: right; background: #f8fafc; width:auto; flex:1;">
        </div>
        
        <div class="result-row">
            <span class="result-label">Category:</span>
            <select id="manCategory" class="btn" style="text-align: right; background: #f8fafc; width:auto; flex:1;">
                <optgroup label="Utilities">
                  <option value="Electricity & Gas">Electricity & Gas</option>
                  <option value="Water & Waste">Water & Waste</option>
                  <option value="Internet & Phone">Internet & Phone</option>
                </optgroup>
                <optgroup label="Marketing">
                  <option value="Advertising">Advertising</option>
                  <option value="Software / Subscriptions">Software / Subscriptions</option>
                </optgroup>
                <optgroup label="Admin / Bank">
                  <option value="Merchant Fees">Merchant Fees</option>
                  <option value="Bank Service Charges">Bank Service Charges</option>
                </optgroup>
                <optgroup label="Professional">
                  <option value="Accounting & Legal">Accounting & Legal</option>
                  <option value="Dues & Subscriptions">Dues & Subscriptions</option>
                  <option value="quickbook">quickbook</option>
                </optgroup>
                <optgroup label="Travel / Auto">
                  <option value="Business Meals">Business Meals</option>
                  <option value="Auto / Mileage">Auto / Mileage</option>
                </optgroup>
                <optgroup label="Employee Costs">
                  <option value="Wages">Wages</option>
                  <option value="Supply" selected>Supply</option>
                  <option value="Other">Other</option>
                </optgroup>
            </select>
        </div>

        <div class="result-row">
            <span class="result-label">Store/Company:</span>
            <input type="text" id="manMerchant" placeholder="e.g. Home Depot" class="btn" style="text-align: right; background: #f8fafc; width:auto; flex:1;">
        </div>

        <div class="result-row">
            <span class="result-label">Items:</span>
            <textarea id="manItems" placeholder="Description..." class="btn" style="text-align: right; background: #f8fafc; width:auto; flex:1; min-height:60px;"></textarea>
        </div>

        <div class="result-row" style="margin-top:12px; border-top:2px solid #f1f5f9; padding-top:12px;">
            <span class="result-label" style="font-size:18px;">Total:</span>
            <input type="number" id="manTotal" step="0.01" placeholder="0.00" class="btn" style="text-align: right; background: #f1f5f9; width:auto; flex:1; font-size:20px; font-weight:800; color:var(--primary);">
        </div>

        <button class="btn btn-primary" onclick="saveManual()" style="width:100%; margin-top:20px;">
            Save Receipt
        </button>
      </div>

    </main>

    <div class="loading-overlay" id="loadingOverlay">
      <div class="spinner"></div>
      <p style="font-weight: 700; color: var(--text-main)">
        AI is analyzing receipt...
      </p>
    </div>

    <canvas id="canvas" hidden></canvas>

    <script>
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const captureBtn = document.getElementById("captureBtn");
      const cameraCard = document.getElementById("cameraCard");
      const previewContainer = document.getElementById("previewContainer");
      const capturedImg = document.getElementById("capturedImg");
      const loadingOverlay = document.getElementById("loadingOverlay");
      const resultCard = document.getElementById("resultCard");

      const SB_URL = "https://ijcxddulqsxwfaqfzmhx.supabase.co";
      const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqY3hkZHVscXN4d2ZhcWZ6bWh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjE2MjgsImV4cCI6MjA4Mzk5NzYyOH0.hQeRBk_08FHpc731rimX8KcEapIr5HrezVsJt9onow8";
      const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

      let stream = null;

      async function startCamera() {
        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false,
          });
          video.srcObject = stream;
        } catch (err) {
          alert("Could not access camera: " + err.message + "\n\nYou can use the 'Upload from Gallery' option instead.");
        }
      }

      function stopCamera() {
        if (stream) stream.getTracks().forEach((t) => t.stop());
      }

      // Image preprocessing for better OCR
      function preprocessImage(imageData) {
        const tempCanvas = document.createElement('canvas');
        const img = new Image();
        img.src = imageData;
        
        return new Promise((resolve) => {
          img.onload = () => {
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            const ctx = tempCanvas.getContext('2d');
            
            // Draw original image
            ctx.drawImage(img, 0, 0);
            
            // Get image data
            const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            
            // Convert to grayscale and increase contrast
            for (let i = 0; i < data.length; i += 4) {
              const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
              // Increase contrast
              const contrast = 1.5;
              const factor = (259 * (contrast + 255)) / (255 * (259 - contrast));
              let value = factor * (avg - 128) + 128;
              value = Math.max(0, Math.min(255, value));
              
              data[i] = data[i + 1] = data[i + 2] = value;
            }
            
            ctx.putImageData(imageData, 0, 0);
            resolve(tempCanvas.toDataURL('image/jpeg', 0.95));
          };
        });
      }

      captureBtn.onclick = () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext("2d").drawImage(video, 0, 0);
        capturedImg.src = canvas.toDataURL("image/jpeg");
        cameraCard.style.display = "none";
        previewContainer.style.display = "block";
        stopCamera();
      };

      // File upload handler
      document.getElementById('fileUpload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            capturedImg.src = event.target.result;
            cameraCard.style.display = "none";
            previewContainer.style.display = "block";
            stopCamera();
          };
          reader.readAsDataURL(file);
        }
      });

      function retake() {
        cameraCard.style.display = "block";
        previewContainer.style.display = "none";
        resultCard.style.display = "none";
        startCamera();
      }

        // Enhanced categorization with more keywords
        function smartCategorize(text) {
          const t = text.toLowerCase();
          
          // Utilities - expanded
          if (t.match(/pg&e|pge|electric|electricity|water|waste|sewer|trash|gas|power|utilities|att|verizon|t-mobile|tmobile|comcast|xfinity|internet|phone|cable|spectrum/)) return 'Utilities';
          
          // Marketing - expanded
          if (t.match(/google|facebook|meta|instagram|ads|advertising|marketing|print|flyer|promo|promotion|social media|adwords/)) return 'Marketing';
          
          // Admin / Bank - expanded
          if (t.match(/bank|banking|fee|charge|interest|service charge|wells fargo|chase|bofa|citibank|merchant|square|stripe|paypal/)) return 'Admin / Bank';
          
          // Professional - expanded (REMOVED 'tax' keyword to prevent false positives)
          if (t.match(/attorney|lawyer|law firm|cpa|accounting firm|accountant|tax service|tax preparation|legal|subscription|software|adobe|microsoft|intuit|quickbooks|turbotax/)) return 'Professional';
          
          // Travel / Auto - expanded
          if (t.match(/chevron|shell|mobil|exxon|texaco|76|arco|gas station|fuel|gasoline|parking|uber|lyft|taxi|flight|airline|hotel|motel|airbnb|travel|rental car|hertz|enterprise/)) return 'Travel / Auto';
          
          // Business Meals - expanded
          if (t.match(/cafe|coffee|starbucks|peet|dunkin|mcdonald|burger king|wendy|in-n-out|taco bell|chipotle|subway|kfc|pizza hut|domino|papa john|restaurant|pho|noodle|sushi|ramen|thai|chinese|vietnamese|korean|mexican|italian|bistro|grill|diner|bakery|bar|pub|dining|lunch|dinner|breakfast|eatery/)) return 'Business Meals';
          
          // Supply - expanded (nail salon specific)
          if (t.match(/nail|nails|beauty|salon|spa|supply|supplies|cosmo|cosmetic|professional|prof|sally|sally beauty|ulta|sephora|polish|gel|acrylic|powder|monomer|uv|led|lamp|drill|file|buffer|store|market|wholesale|distributor|amazon|target|walmart|costco|home depot|lowes|office depot|staples/)) return 'Supply';
          
          return 'Other';
        }

        function parseReceiptText(text) {
          // Handle single-line OCR by splitting on common delimiters
          let normalizedText = text.replace(/\s+(TOTAL|SUBTOTAL|TAX|DATE|ITEM)/gi, '\n$1');
          const lines = normalizedText.split('\n').map(l => l.trim()).filter(Boolean);
          
          let companyStore = null; 
          let total = null;
          let category = 'Other'; 
          let items = [];

          // FIXED: Use word boundaries to prevent SUBTOTAL from matching
          const totalPatterns = [
            // Prioritize exact "TOTAL" matches (not SUBTOTAL)
            /\bTOTAL[:\s]*\$?\s*([\d,]+\.\d{2})/i,
            /\$\s*([\d,]+\.\d{2})\s*\bTOTAL\b/i,
            /\b(?:GRAND TOTAL|FINAL TOTAL)[:\s]*\$?\s*([\d,]+\.\d{2})/i,
            /\b(?:AMOUNT DUE|BALANCE DUE)[:\s]*\$?\s*([\d,]+\.\d{2})/i,
            /\b(?:YOU PAID|PAYMENT|CHARGED)[:\s]*\$?\s*([\d,]+\.\d{2})/i,
            // Last resort: match any "total" but exclude SUBTOTAL explicitly
            /(?<!SUB)TOTAL[:\s]*\$?\s*([\d,]+\.\d{2})/i
          ];

          // Search from bottom up for total (actual total is usually at bottom)
          for (const line of [...lines].reverse()) {
            // Skip lines with SUBTOTAL explicitly
            if (line.toUpperCase().includes('SUBTOTAL')) continue;
            
            if (total !== null) break;
            for (const pattern of totalPatterns) {
              const match = line.match(pattern);
              if (match) {
                const num = parseFloat(match[1].replace(/,/g, ''));
                if (!isNaN(num) && num > 0 && num < 10000) {
                  total = num;
                  console.log('‚úÖ Found TOTAL:', num, 'from line:', line);
                  break;
                }
              }
            }
          }
          
          // Fallback: find largest reasonable number (total is usually the largest)
          if (total === null) {
              const numbers = text.match(/\$?\s*([\d,]+\.\d{2})/g);
              if (numbers) {
                  const validNums = numbers
                    .map(n => parseFloat(n.replace(/[^\d.]/g, '')))
                    .filter(n => n > 0.50 && n < 10000);
                  if (validNums.length > 0) {
                    total = Math.max(...validNums);
                    console.log('‚ö†Ô∏è Using fallback TOTAL (largest number):', total);
                  }
              }
          }

          // Enhanced date detection with normalization
          let date = null;
          const datePatterns = [
            /\b(\d{4}-\d{2}-\d{2})\b/,                                    // YYYY-MM-DD
            /\b(\d{1,2}\/\d{1,2}\/\d{4})\b/,                            // MM/DD/YYYY
            /\b(\d{1,2}\/\d{1,2}\/\d{2})\b/,                            // MM/DD/YY
            /\b(\d{1,2}-\d{1,2}-\d{2,4})\b/,                            // MM-DD-YYYY
            /((?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*[\s,]+\d{1,2}[\s,]+\d{4})/i,  // Month DD, YYYY
            /\b(\d{1,2}\s+(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\s+\d{4})\b/i     // DD Month YYYY
          ];

          for (const line of lines) {
            for (const pattern of datePatterns) {
              const match = line.match(pattern);
              if (match) {
                date = match[1];
                // Try to normalize to YYYY-MM-DD
                try {
                  const parsed = new Date(date);
                  if (!isNaN(parsed.getTime())) {
                    date = parsed.toISOString().split('T')[0];
                  }
                } catch (e) {
                  // Keep original if parsing fails
                }
                break;
              }
            }
            if (date) break;
          }
          
          // Better merchant name detection
          for (const line of lines.slice(0, 10)) {  // Check first 10 lines
              const cleaned = line.replace(/[^\w\s'&.-]/g, '').trim();
              // Skip lines that are mostly numbers, dates, or common receipt words
              if (cleaned.length > 3 && 
                  !line.match(/\d{1,2}[\/\-]\d{1,2}/) && 
                  !line.match(/^\d+$/) &&
                  !line.toLowerCase().match(/^(total|subtotal|tax|receipt|invoice|thank you|visit|store|location)$/)) {
                  companyStore = cleaned;
                  break;
              }
          }

          // Extract item descriptions
          const descLines = lines.filter(l => {
            const lowerLine = l.toLowerCase();
            return !lowerLine.includes('total') &&
                   !lowerLine.includes('subtotal') &&
                   !lowerLine.includes('tax') &&
                   (!date || !l.includes(date)) &&
                   l !== companyStore &&
                   l.length > 3 &&
                   !l.match(/^[\d\s\$\.,]+$/);  // Skip lines with only numbers/symbols
          });
          
          const descText = descLines.slice(0, 5).join(', ');
          category = smartCategorize(text + " " + (companyStore || ''));

          return { 
            date: date || new Date().toISOString().split('T')[0], 
            companyStore: companyStore || 'Unknown Store', 
            total: total || 0, 
            transactionType: category,
            items: descText, 
            raw_text: text 
          };
        }

        async function process() {
            loadingOverlay.style.display = 'flex';
            const statusText = loadingOverlay.querySelector('p');
            statusText.textContent = "Enhancing image...";

            try {
                // Preprocess image for better OCR
                const processedImage = await preprocessImage(capturedImg.src);
                
                statusText.textContent = "Loading AI Brain...";
                
                // Client-side OCR using Tesseract.js
                const { data: { text } } = await Tesseract.recognize(
                  processedImage,
                  'eng',
                  {
                    logger: m => {
                        if(m.status === 'recognizing text') {
                           statusText.textContent = `Reading Receipt... ${Math.round(m.progress * 100)}%`;
                        } else {
                           statusText.textContent = m.status;
                        }
                    }
                  }
                );

                console.log("OCR Output:", text);
                statusText.textContent = "Analyzing data...";
                
                const data = parseReceiptText(text);

                document.getElementById('resMerchant').value = data.companyStore || '';
                document.getElementById('resTotal').value = (data.total || 0).toFixed(2);
                document.getElementById('resDate').value = data.date || '';
                
                const select = document.getElementById('resType');
                if (data.transactionType && data.transactionType !== 'Other') {
                     for(let i=0; i<select.options.length; i++) {
                         if(select.options[i].value === data.transactionType) {
                             select.selectedIndex = i;
                             break;
                         }
                     }
                }
                
                // Show items with raw text for debugging
                const itemsText = data.items || '';
                const debugInfo = itemsText ? itemsText : `[Raw OCR: ${text.substring(0, 100)}...]`;
                document.getElementById('resItems').value = debugInfo;
                
                resultCard.style.display = 'block';
                previewContainer.style.display = 'none';
            } catch (err) {
                alert('Analysis failed: ' + err.message + '\n\nTry taking a clearer photo or use manual entry below.');
                console.error(err);
                // Show preview again so user can retake
                previewContainer.style.display = 'block';
            } finally {
                loadingOverlay.style.display = 'none';
                statusText.textContent = "AI is analyzing receipt...";
            }
        }

        async function saveToBudget() {
            const expense = {
                date: document.getElementById('resDate').value,
                companyStore: document.getElementById('resMerchant').value,
                total: parseFloat(document.getElementById('resTotal').value),
                transactionType: document.getElementById('resType').value,
                subcategory: document.getElementById('resType').value,
                items: document.getElementById('resItems').value
            };
            await saveExpense(expense, () => {
                // On success for scan
                resultCard.style.display = "none";
                cameraCard.style.display = "block";
                startCamera();
            });
        }
        
        async function saveManual() {
            const expense = {
                date: document.getElementById('manDate').value,
                companyStore: document.getElementById('manMerchant').value,
                total: parseFloat(document.getElementById('manTotal').value),
                transactionType: document.getElementById('manCategory').value,
                subcategory: document.getElementById('manCategory').value,
                items: document.getElementById('manItems').value
            };
            
            if(!expense.total || !expense.companyStore) {
                alert("Please enter at least a Company Name and Total.");
                return;
            }

            await saveExpense(expense, () => {
                // Reset form
                document.getElementById('manMerchant').value = '';
                document.getElementById('manTotal').value = '';
                document.getElementById('manItems').value = '';
                document.getElementById('manCategory').value = 'Supply';
            });
        }

        async function saveExpense(expense, onSuccess) {
            loadingOverlay.style.display = 'flex';
            try {
                const { data, error } = await supabaseClient
                    .from('receipts')
                    .insert([expense]);

                if (error) throw error;

                // Success
                alert("‚úÖ Receipt Saved Successfully!");
                
                if(onSuccess) onSuccess();

            } catch (err) {
                alert('Save failed: ' + err.message);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

      startCamera();
    </script>
  </body>
</html>
