<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://cdn.jsdelivr.net https://ijcxddulqsxwfaqfzmhx.supabase.co https://fonts.googleapis.com https://fonts.gstatic.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://ijcxddulqsxwfaqfzmhx.supabase.co; img-src 'self' data:">
    <title>K&T Nails & Spa - Pay Calculator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        /* Premium Spa Palette - Warm Stone & Sophisticated Rose */
        --primary: #BE185D;       /* Pink-700 */
        --primary-soft: #FBCFE8;  /* Pink-200 */
        --secondary: #F472B6;     /* Pink-400 */
        --success: #059669;       /* Emerald-600 */
        --danger: #E11D48;        /* Rose-600 */
        --warning: #D97706;       /* Amber-600 */
        
        --background: #FAFAF9;    /* Warm Stone-50 */
        --sidebar-bg: #FFFFFF;    /* Clean White */
        --card-bg: #FFFFFF;
        
        --text-main: #1C1917;     /* Stone-900 */
        --text-muted: #57534E;    /* Stone-600 */
        --border: #E7E5E4;        /* Stone-200 */
        
        --shadow-sm: 0 1px 2px rgba(28, 25, 23, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(28, 25, 23, 0.05), 0 2px 4px -1px rgba(28, 25, 23, 0.03);
        --shadow-lg: 0 10px 15px -3px rgba(190, 24, 93, 0.05), 0 4px 6px -2px rgba(190, 24, 93, 0.025);
        --radius-lg: 16px;
        --radius-xl: 24px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", sans-serif;
        background-color: var(--background);
        color: var(--text-main);
        line-height: 1.6;
        overflow-x: hidden;
        display: flex;
        min-height: 100vh;
      }

      /* Sidebar */
      .sidebar {
        width: 280px;
        background: var(--sidebar-bg);
        padding: 32px 24px;
        display: flex;
        flex-direction: column;
        gap: 32px;
        position: fixed;
        height: 100vh;
        overflow-y: auto;
        border-right: 1px solid var(--border);
      }

      .logo-section {
        text-align: center;
      }

      .logo-section img {
        width: 120px;
        height: auto;
        margin-bottom: 16px;
        border-radius: 12px;
      }

      .logo-section h2 {
        font-family: "Playfair Display", serif;
        font-size: 22px;
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 4px;
        letter-spacing: -0.01em;
      }

      .logo-section p {
        font-size: 12px;
        color: var(--text-muted);
        font-weight: 500;
      }

      .nav-menu {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .nav-item {
        padding: 14px 20px;
        border-radius: 12px;
        color: var(--text-muted);
        text-decoration: none;
        font-weight: 600;
        font-size: 15px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .nav-item:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--primary);
      }

      .nav-item.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
      }

      .dashboard-container {
        margin-left: 280px;
        padding: 32px;
        flex: 1;
        max-width: calc(100% - 280px);
      }

      /* Header */
      .dashboard-header {
        margin-bottom: 32px;
        text-align: center;
      }

      .dashboard-header h1 {
        font-family: "Playfair Display", serif;
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        color: var(--text-main);
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: var(--card-bg);
        border-radius: var(--radius-xl);
        padding: 24px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
        transition: all 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-soft);
      }

      .stat-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-family: "Playfair Display", serif;
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 4px;
        color: var(--text-main);
        letter-spacing: -0.02em;
      }

      .stat-change {
        font-size: 14px;
        font-weight: 600;
      }

      .stat-change.positive {
        color: var(--success);
      }

      .stat-change.negative {
        color: var(--danger);
      }

      /* Chart Section */
      .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 32px;
      }

      .chart-card {
        background: var(--card-bg);
        border-radius: var(--radius-xl);
        padding: 28px;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
      }

      .chart-card h3 {
        font-family: "Playfair Display", serif;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 24px;
        color: var(--text-main);
      }


      /* Calendar Grid */
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .month-title {
        font-family: "Playfair Display", serif;
        font-size: 24px;
        font-weight: 700;
        color: var(--text-main);
      }

      .month-nav {
        display: flex;
        gap: 10px;
      }

      .month-nav button {
        padding: 8px 16px;
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }

      .month-nav button:hover {
        background: var(--primary);
        color: white;
      }

      .weekday-headers {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 8px;
      }

      .weekday-header {
        text-align: center;
        font-size: 12px;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        padding: 8px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        padding-bottom: 20px;
      }

      .day-cell {
        background: rgba(236, 72, 153, 0.05);
        border-radius: 12px;
        padding: 12px 8px;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .day-cell:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(236, 72, 153, 0.2);
      }

      .day-cell.other-month {
        opacity: 0.3;
        background: rgba(0, 0, 0, 0.02);
      }

      .day-cell.has-sales {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.15), rgba(244, 114, 182, 0.15));
        border-color: rgba(236, 72, 153, 0.3);
      }

      .day-cell.in-period {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
        border-color: rgba(16, 185, 129, 0.4);
      }

      .day-cell.in-period.has-sales {
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.25), rgba(244, 114, 182, 0.25));
        border-color: var(--primary);
      }

      .day-cell.selected {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
      }

      .day-number {
        font-size: 18px;
        font-weight: 900;
        margin-bottom: 6px;
      }

      .day-amount {
        font-size: 11px;
        font-weight: 700;
        color: var(--success);
      }

      .day-cell.selected .day-amount {
        color: white;
      }

      .day-cell.no-sales .day-amount {
        color: var(--text-muted);
        font-size: 10px;
      }

      .day-cell.other-month .day-amount {
        display: none;
      }

      /* Yearly Sales Tracker */
      .yearly-sales {
        background: var(--card-bg);
        border-radius: 24px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--border);
      }

      .yearly-sales h3 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
      }

      .year-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, rgba(236, 72, 153, 0.05), rgba(244, 114, 182, 0.05));
        border-radius: 12px;
        border: 1px solid rgba(236, 72, 153, 0.2);
      }

      .year-label {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
      }

      .year-stats {
        text-align: right;
      }

      .year-sales {
        font-size: 24px;
        font-weight: 900;
        color: var(--primary);
      }

      .year-profit {
        font-size: 13px;
        font-weight: 600;
        color: var(--success);
        margin-top: 4px;
      }

      .year-projection {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed rgba(0, 0, 0, 0.1);
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 60px;
        color: var(--text-muted);
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Quick Actions */
      .quick-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .action-btn {
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }

      .action-btn.primary {
        background: var(--primary);
        color: white;
      }

      .action-btn.secondary {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .action-btn:active {
        transform: scale(0.98);
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .sidebar {
          width: 240px;
        }

        .dashboard-container {
          margin-left: 240px;
          max-width: calc(100% - 240px);
        }

        .charts-section {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          display: none;
        }

        .dashboard-container {
          margin-left: 0;
          max-width: 100%;
          padding: 16px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
      }

      .modal-overlay.active {
        display: flex;
        animation: fadeIn 0.2s ease-out;
      }

      .modal-content {
        background: white;
        border-radius: 24px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        padding: 24px;
        position: relative;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }

      .modal-title {
        font-size: 20px;
        font-weight: 800;
        color: var(--text-main);
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: var(--text-muted);
        cursor: pointer;
        padding: 4px;
        line-height: 1;
        border-radius: 8px;
        transition: all 0.2s;
      }

      .close-btn:hover {
        background: var(--background);
        color: var(--danger);
      }

      .worker-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .worker-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        background: var(--background);
        border-radius: 12px;
        transition: all 0.2s;
      }
      
      .worker-item:hover {
        transform: translateX(4px);
        background: #f1f5f9;
      }

      .worker-name {
        font-weight: 600;
        color: var(--text-main);
      }

      .worker-amount {
        font-weight: 700;
        color: var(--primary);
      }

      .modal-total {
        margin-top: 20px;
        padding-top: 16px;
        border-top: 2px dashed var(--border);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .total-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
      }

      .total-amount {
        font-size: 24px;
        font-weight: 900;
        color: var(--success);
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="logo-section">
        <img src="kntlogo2026.png" alt="K&T Nails & Spa">
        <h2>K&T NAILS & SPA</h2>
        <p>Business Dashboard</p>
      </div>

      <nav class="nav-menu">
        <a href="index.html" class="nav-item active">üè† Dashboard</a>
        <a href="dashboard.html" class="nav-item">üí∞ Enter Sales</a>
        <a href="business-budget.html" class="nav-item">üìà Budget</a>
        <a href="receipt-list.html" class="nav-item">üìã Business Receipts</a>
        <a href="receipt-scanner.html" class="nav-item">üì∏ Receipt Scanner</a>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1>Dashboard Overview</h1>
        <div id="cacheStatus" style="font-size: 12px; color: var(--success); margin-bottom: 4px; font-weight: 600;"></div>
        <select id="yearSelect" onchange="handleYearChange(this.value)" style="font-size: 16px; font-weight: 700; color: var(--primary); margin-bottom: 12px; background: rgba(0,0,0,0.03); display: inline-block; padding: 6px 16px; border-radius: 20px; border: 1px solid var(--primary); outline: none; cursor: pointer;">
        </select>
        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 8px;">
          <button id="forceRefreshBtn" class="action-btn" style="padding: 8px 16px; font-size: 14px; max-width: 200px; margin: 0;">
            üîÑ Force Refresh
          </button>
        </div>
      </div>

      <!-- Key Stats -->
      <div class="stats-grid">
        <div class="stat-card" style="border-left: 4px solid var(--primary);">
          <div class="stat-label">Gross Sales</div>
          <div class="stat-value" id="statGrossSales">$0</div>
          <div class="stat-change" id="statGrossChange">YTD: $0</div>
        </div>

        <div class="stat-card" style="border-left: 4px solid var(--success);">
          <div class="stat-label">Net Income</div>
          <div class="stat-value" id="statNetIncome">$0</div>
          <div class="stat-change" id="statNetChange">YTD: $0</div>
        </div>

        <div class="stat-card" style="border-left: 4px solid var(--secondary);">
          <div class="stat-label">Total Staff Pay</div>
          <div class="stat-value" id="statStaffPay">$0</div>
          <div class="stat-change" id="statStaffChange">YTD: $0</div>
        </div>


      </div>

      <!-- Charts Section -->
      <div class="charts-section">
        <div class="chart-card">
          <div class="calendar-header">
            <div class="month-title" id="monthTitle">Loading...</div>
            <div class="month-nav">
              <button onclick="changeMonth(-1)">‚Üê Prev</button>
              <button onclick="changeMonth(0)">Today</button>
              <button onclick="changeMonth(1)">Next ‚Üí</button>
            </div>
          </div>
          <div class="weekday-headers">
            <div class="weekday-header">Sun</div>
            <div class="weekday-header">Mon</div>
            <div class="weekday-header">Tue</div>
            <div class="weekday-header">Wed</div>
            <div class="weekday-header">Thu</div>
            <div class="weekday-header">Fri</div>
            <div class="weekday-header">Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <div class="loading">
              <div class="spinner"></div>
              Loading calendar data...
            </div>
          </div>
        </div>

        <div class="yearly-sales">
          <h3>üìä Yearly Sales Tracker</h3>
          <div id="yearlySales">
            <div class="loading">
              <div class="spinner"></div>
              Loading...
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- Day Details Modal -->
    <div id="dayDetailsModal" class="modal-overlay" onclick="closeModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <div class="modal-title" id="modalDateTitle">Date Details</div>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div id="modalBody" class="worker-list">
          <!-- Worker items will be injected here -->
        </div>
        <div class="modal-total" style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div class="total-label">Total Sales</div>
            <div class="total-amount" id="modalTotalAmount">$0</div>
          </div>
          <button id="modalEditBtn" class="action-btn secondary" style="padding: 8px 16px; font-size: 13px;">‚úèÔ∏è Edit</button>
        </div>
      </div>
    </div>

    <script>
      const SB_URL = "https://ijcxddulqsxwfaqfzmhx.supabase.co";
      const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqY3hkZHVscXN4d2ZhcWZ6bWh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjE2MjgsImV4cCI6MjA4Mzk5NzYyOH0.hQeRBk_08FHpc731rimX8KcEapIr5HrezVsJt9onow8";
      var supabaseClient = supabase.createClient(SB_URL, SB_KEY);

      const SERVICE_RATE = 0.55;
      const ANCHOR_DATE = new Date("2026-01-01T00:00:00");

      let selectedYear = new Date().getFullYear();
      let yearDataCache = {};
      let ytdData = [];
      let currentViewMonth = new Date(); // For calendar navigation
      let monthDataCache = {}; // Cache for monthly data

      // Cache key format: "ytd_cache_2026-01-15" (stores data up to this end date)
      const YTD_CACHE_PREFIX = "ytd_cache_";

      const fmt = (num) => new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 0,
      }).format(num);

      window.onload = null; // Prevent conflict if defined elsewhere

      // Robust startup
      // Setup DOM listeners
      function setupEventListeners() {
        console.log("üõ†Ô∏è Setting up event listeners...");
        const refreshBtn = document.getElementById("forceRefreshBtn");
        if (refreshBtn) {
          refreshBtn.addEventListener("click", manualForceRefresh);
        }
      }

      // Robust startup
      function startApp() {
        console.log("üöÄ startApp is running!"); 
        
        // Wait for Supabase if strictly necessary
        if (typeof supabase === 'undefined') {
          console.warn("Supabase not ready, retrying in 100ms...");
          setTimeout(startApp, 100);
          return;
        }

        console.log("Supabase library loaded. Starting initialization...");
        
        // 1. Setup listeners
        setupEventListeners();

        // 2. Pull the trigger
        initializeDashboard();

        // Safety timeout
        setTimeout(() => {
          if (document.querySelector(".loading") || document.getElementById("monthTitle").textContent === "Loading...") {
            console.error("App initialization timed out after 15s");
            if (!document.getElementById("statGrossSales").textContent.includes("$") || 
                document.getElementById("statGrossSales").textContent === "$0") {
               showError("Connection timed out. <br>Please click 'Force Refresh' or check internet.");
            }
          }
        }, 15000);
      }

      // Hook into page load
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', startApp);
      } else {
        startApp();
      }

      async function initializeDashboard() {
        updateStatus("Initializing...");
        
        // 1. Load Saved Year
        const savedYear = localStorage.getItem("selectedYear");
        if (savedYear) {
            selectedYear = parseInt(savedYear);
        }
        
        populateYearSelect();

        // Set current month for calendar (Default to Jan of selected year if past, or current month if current year)
        const now = new Date();
        if (selectedYear === now.getFullYear()) {
            currentViewMonth = now;
        } else {
            currentViewMonth = new Date(selectedYear, 11, 1); // Dec of that year
        }

        // Load data
        console.log("Auto-initializing dashboard...");
        await new Promise(resolve => setTimeout(resolve, 500));

        try {
          await loadDashboardData();
          console.log("‚úÖ Initial load successful");
        } catch (err) {
          console.error("Initial load failed", err);
          updateStatus("Connection issue. Please retry.", "var(--danger)");
        }
      }

      function populateYearSelect() {
          const select = document.getElementById("yearSelect");
          if(!select) return;
          select.innerHTML = "";
          
          const currentY = new Date().getFullYear();
          // Show range of years, e.g. 2024 to Current + 1
          const startY = 2024;
          const endY = currentY + 1;
          
          for(let y = startY; y <= endY; y++) {
              const opt = document.createElement("option");
              opt.value = y;
              opt.textContent = y;
              if (y === selectedYear) opt.selected = true;
              select.appendChild(opt);
          }
      }

      function handleYearChange(val) {
          selectedYear = parseInt(val);
          localStorage.setItem("selectedYear", selectedYear);
          
          // Reset view month
          const now = new Date();
          if (selectedYear === now.getFullYear()) {
             currentViewMonth = now;
          } else {
             currentViewMonth = new Date(selectedYear, 0, 1); // Jan
          }
          
          loadDashboardData(true);
      }

      function updateStatus(msg, color = "var(--warning)") {
        const statusEl = document.getElementById("cacheStatus");
        if (statusEl) {
          statusEl.textContent = "‚ö° " + msg;
          statusEl.style.color = color;
        }
      }

      async function manualForceRefresh() {
        console.log("Manual force refresh triggered");
        updateStatus("Refreshing data...", "var(--warning)");
        await loadDashboardData(true);
      }

      async function loadDashboardData(forceRefresh = false) {
        try {
          updateStatus("Loading Data...");
          
          // Fetch ALL history for YoY comparison
          // We rely on client-side filtering for the specific year view
          
          if (!forceRefresh && yearDataCache['all']) {
              await processAndRender(yearDataCache['all']);
              updateStatus("‚úì Data Loaded (Cached)", "var(--success)");
              return;
          }
          
          const { data, error } = await supabaseClient
            .from("sales_records")
            .select("*")
            .order("entry_date", { ascending: true })
            .range(0, 9999); // Fetch up to 10k records to bypass default 1000 limit

          if (error) throw new Error(error.message);

          const allRecords = data || [];
          yearDataCache['all'] = allRecords;
          
          updateStatus("‚úì Data Sync Complete", "var(--primary)");
          await processAndRender(allRecords);

        } catch (err) {
          console.error("Dashboard Load Error:", err);
          updateStatus("Connection issue. Please retry.", "var(--danger)");
          throw err;
        }
      }

      async function processAndRender(allRecords) {
        try {
            // Store full history globally for other uses if needed
            ytdData = allRecords; 

            // Filter for Selected Year for the Main Dashboard view (Cards, Charts)
            const yearStr = String(selectedYear);
            const currentYearRecords = allRecords.filter(r => r.entry_date.startsWith(yearStr));

            const workers = new Set();
            currentYearRecords.forEach(r => workers.add(r.worker_name));
            
            // Pass filtered records for dashboard stats, but we will call renderYoYComparison independently or pass allRecords
            await renderDashboard(Array.from(workers), currentYearRecords);
            
            // Render YoY Comparison using ALL data
            renderYoYComparison(allRecords);

        } catch (e) {
            console.error("Error in processAndRender:", e);
            throw e;
        }
      }

      function showError(msg) {
        const errHTML = `<div style="padding: 20px; color: var(--danger); text-align: center;">
          <p><strong>‚ö†Ô∏è Error</strong></p>
          <p>${msg}</p>
        </div>`;
        document.getElementById("calendarGrid").innerHTML = errHTML;
      }

      async function renderDashboard(workers, records) {
        // Calculate Year stats
        let grossSales = 0;
        let totalDiscounts = 0;
        let totalStaffPay = 0;
        
        // Define workerStats
        let workerStats = {};
        workers.forEach(w => workerStats[w] = { sales: 0, pay: 0 });

        // Deduplicate days for discount calculation
        let dailyMap = {};

        records.forEach(r => {
             // Sales
             let amt = parseFloat(r.amount) || 0;
             if (workerStats[r.worker_name]) {
                workerStats[r.worker_name].sales += amt;
             }
             
             // Daily Aggregation for Global Stats
             if (!dailyMap[r.entry_date]) {
                 dailyMap[r.entry_date] = { sales: 0, discount: 0 };
             }
             dailyMap[r.entry_date].sales += amt;
             
             // Track max discount seen for this day
             let d = (parseFloat(r.discount) || 0) + (parseFloat(r.loyalty_discount) || 0);
             if (d > dailyMap[r.entry_date].discount) {
                 dailyMap[r.entry_date].discount = d;
             }
        });
        
        // Sum totals
        Object.values(dailyMap).forEach(day => {
            grossSales += day.sales;
            totalDiscounts += day.discount;
        });

        // Calculate Pay
        workers.forEach(w => {
           if (w.toLowerCase() !== 'kim') {
               const pay = Math.round(workerStats[w].sales * SERVICE_RATE);
               workerStats[w].pay = pay;
               totalStaffPay += pay;
           }
        });

        const netIncome = grossSales - totalDiscounts - totalStaffPay;

        // Render Cards
        document.getElementById("statGrossSales").textContent = fmt(grossSales - totalDiscounts); 
        document.getElementById("statGrossChange").textContent = `Total in ${selectedYear}`;

        document.getElementById("statNetIncome").textContent = fmt(netIncome);
        document.getElementById("statNetChange").textContent = `Profit in ${selectedYear}`;

        document.getElementById("statStaffPay").textContent = fmt(totalStaffPay);
        document.getElementById("statStaffChange").textContent = `Staff Pay in ${selectedYear}`;

        // Render Calendar
        try {
            // We need to ensure cached month data is refreshed if we fetched new data
            // Since we rely on Supabase fetch in renderCalendar which filters by date, 
            // we should probably refactor renderCalendar to use our local `records` if they are fully loaded?
            // Existing renderCalendar fetches from Supabase again. That's fine for now to keep it isolated,
            // or we could optimize it. Given the instruction to keep changes focused, I'll leave renderCalendar as is.
            await renderCalendar();
        } catch(e) { console.error(e); }
        
        // renderYoYComparison is called in processAndRender
      }

      function renderYoYComparison(allRecords) {
        const container = document.getElementById("yearlySales");
        const prevYear = selectedYear - 1;

        const yearStats = {};
        const initMonth = () => ({ sales: 0, discounts: 0 });

        // Process all records
        allRecords.forEach(r => {
            // Robust date parsing
            // entry_date is YYYY-MM-DD. 
            const parts = r.entry_date.split('-');
            const y = parseInt(parts[0]);
            const m = parseInt(parts[1]) - 1; // 0-indexed

            if (!yearStats[y]) yearStats[y] = {};
            if (!yearStats[y][m]) yearStats[y][m] = initMonth();
            
            if(!yearStats[y][m].days) yearStats[y][m].days = {};
            if(!yearStats[y][m].days[r.entry_date]) yearStats[y][m].days[r.entry_date] = { sales: 0, disc: 0 };
            
            yearStats[y][m].days[r.entry_date].sales += (parseFloat(r.amount)||0);
            
            let d = (parseFloat(r.discount)||0) + (parseFloat(r.loyalty_discount)||0);
            if (d > yearStats[y][m].days[r.entry_date].disc) {
                yearStats[y][m].days[r.entry_date].disc = d;
            }
        });

        // Summarize
        Object.keys(yearStats).forEach(y => {
            Object.keys(yearStats[y]).forEach(m => {
                let sales = 0;
                let discs = 0;
                Object.values(yearStats[y][m].days).forEach(day => {
                    sales += day.sales;
                    discs += day.disc;
                });
                yearStats[y][m].netSales = sales - discs;
            });
        });

        const months = [
            "January", "February", "March", "April", "May", "June", 
            "July", "August", "September", "October", "November", "December"
        ];

        let html = `
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:16px;">
                 <h3 style="margin:0; font-family: 'Playfair Display', serif;">üìÖ Year Over Year Comparison</h3>
            </div>
            <div style="font-size:14px; color:var(--text-muted); margin-bottom:12px; font-weight:500;">
                Comparing <span style="color:var(--primary); font-weight:700;">${selectedYear}</span> vs ${prevYear}
            </div>
            
            <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 12px;">
            <table style="width: 100%; border-collapse: collapse; font-family: 'Inter', sans-serif;">
                <thead>
                    <tr style="background: rgba(0,0,0,0.02); border-bottom: 1px solid var(--border);">
                        <th style="text-align: left; padding: 12px 16px; color: var(--text-muted); font-size:12px; text-transform:uppercase;">Month</th>
                        <th style="text-align: right; padding: 12px 16px; color: var(--text-muted); font-size:12px; text-transform:uppercase;">${prevYear}</th>
                        <th style="text-align: right; padding: 12px 16px; color: var(--primary); font-size:12px; text-transform:uppercase;">${selectedYear}</th>
                        <th style="text-align: right; padding: 12px 16px; color: var(--text-muted); font-size:12px; text-transform:uppercase;">Change</th>
                    </tr>
                </thead>
                <tbody>
        `;

        let currentTotal = 0;
        let prevTotal = 0;

        months.forEach((monthName, i) => {
            const valCurr = (yearStats[selectedYear] && yearStats[selectedYear][i]) ? yearStats[selectedYear][i].netSales : 0;
            const valPrev = (yearStats[prevYear] && yearStats[prevYear][i]) ? yearStats[prevYear][i].netSales : 0;
            
            currentTotal += valCurr;
            prevTotal += valPrev;

            let changePct = 0;
            let changeClass = "neutral";
            let changeIcon = "";

            if (valPrev > 0) {
                changePct = ((valCurr - valPrev) / valPrev) * 100;
                if (changePct > 0) { changeClass = "positive"; changeIcon = "‚ñ≤"; } // Unified font arrows
                else if (changePct < 0) { changeClass = "negative"; changeIcon = "‚ñº"; }
            } else if (valCurr > 0) {
                changePct = 100;
                changeClass = "positive";
                changeIcon = "‚òÖ"; // New
            }

            const pctStr = Math.abs(changePct).toFixed(1) + "%";
            const color = changeClass === "positive" ? "var(--success)" : changeClass === "negative" ? "var(--danger)" : "var(--text-muted)";
            
            // Logic: Show row if verifyCurrent has data OR verifyPrev has data.
            // Always show all months for structure? Yes looks better.
            
            html += `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px 16px; font-weight: 500; font-size: 14px;">${monthName}</td>
                    <td style="padding: 12px 16px; text-align: right; font-family: 'Inter', sans-serif; color: var(--text-muted);">${valPrev > 0 ? fmt(valPrev) : '-'}</td>
                    <td style="padding: 12px 16px; text-align: right; font-family: 'Inter', sans-serif; font-weight: 600; color:var(--text-main);">${valCurr > 0 ? fmt(valCurr) : '-'}</td>
                    <td style="padding: 12px 16px; text-align: right; color: ${color}; font-weight: 600; font-size:13px;">
                        ${(valCurr === 0 && valPrev === 0) ? '' : `${changeIcon} ${pctStr}`}
                    </td>
                </tr>
            `;
        });

        // Totals
         let totalChangePct = 0;
         let totalIcon = "";
         let totalColor = "var(--text-muted)";
         
         if (prevTotal > 0) {
            totalChangePct = ((currentTotal - prevTotal) / prevTotal) * 100;
            if (totalChangePct > 0) { totalIcon = "‚ñ≤"; totalColor = "var(--success)"; }
            else if (totalChangePct < 0) { totalIcon = "‚ñº"; totalColor = "var(--danger)"; }
         } else if (currentTotal > 0) {
             totalChangePct = 100;
             totalIcon = "‚òÖ";
             totalColor = "var(--success)";
         }

        html += `
                <tr style="background: rgba(0,0,0,0.02);">
                    <td style="padding: 12px 16px; font-weight: 700;">TOTAL</td>
                    <td style="padding: 12px 16px; text-align: right; font-weight: 700;">${fmt(prevTotal)}</td>
                    <td style="padding: 12px 16px; text-align: right; font-weight: 700; color: var(--primary);">${fmt(currentTotal)}</td>
                    <td style="padding: 12px 16px; text-align: right; font-weight: 800; color: ${totalColor};">
                        ${totalIcon} ${Math.abs(totalChangePct).toFixed(1)}%
                    </td>
                </tr>
            </tbody>
        </table>
        </div>`;

        container.innerHTML = html;
      }

      async function renderCalendar() {
        const container = document.getElementById("calendarGrid");
        
        // Show local spinner if empty
        if (!container.innerHTML || container.textContent.includes("Failed")) {
             container.innerHTML = `
            <div class="loading">
              <div class="spinner"></div>
              Loading calendar...
            </div>`;
        }

        // Update month title
        const monthTitle = currentViewMonth.toLocaleDateString("en-US", { month: "long", year: "numeric" });
        document.getElementById("monthTitle").textContent = monthTitle;

        // Get first and last day of the month
        const year = currentViewMonth.getFullYear();
        const month = currentViewMonth.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        // Get starting Sunday (may be from previous month)
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay()); // Go back to Sunday

        // Get ending Saturday (may be from next month)
        const endDate = new Date(lastDay);
        endDate.setDate(endDate.getDate() + (6 - lastDay.getDay())); // Go forward to Saturday

        // Fetch month data
        const startDateStr = startDate.toISOString().split("T")[0];
        const endDateStr = endDate.toISOString().split("T")[0];

        try {
            const { data, error } = await supabaseClient
              .from("sales_records")
              .select("*")
              .gte("entry_date", startDateStr)
              .lte("entry_date", endDateStr);

            if (error) throw error;

            // Clear spinner only on success
            container.innerHTML = "";

            // Build cache for this month
            monthDataCache = {};
            if (data) {
              data.forEach(row => {
                if (!monthDataCache[row.entry_date]) {
                  monthDataCache[row.entry_date] = { incomes: {}, discount: 0, loyalty: 0 };
                }
                monthDataCache[row.entry_date].incomes[row.worker_name] = parseFloat(row.amount) || 0;
                monthDataCache[row.entry_date].discount = parseFloat(row.discount) || 0;
                monthDataCache[row.entry_date].loyalty = parseFloat(row.loyalty_discount || 0);
              });
            }

            // Render calendar cells
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
              const dateStr = currentDate.toISOString().split("T")[0];
              const entry = monthDataCache[dateStr] || { incomes: {}, discount: 0, loyalty: 0 };

              let total = 0;
              Object.values(entry.incomes).forEach(val => total += val);

              const isToday = currentDate.getTime() === today.getTime();
              const isCurrentMonth = currentDate.getMonth() === month;
              // const inPeriod = currentPeriodDates.includes(dateStr); // Removed to prevent error

              const cell = document.createElement("div");
              cell.className = "day-cell";

              if (!isCurrentMonth) {
                cell.classList.add("other-month");
              }

              if (total > 0) {
                cell.classList.add("has-sales");
              } else {
                cell.classList.add("no-sales");
              }
              
              // No longer highlighting "in-period" since we are in year view


              if (isToday) {
                cell.classList.add("selected");
              }

              cell.innerHTML = `
                <div class="day-number">${currentDate.getDate()}</div>
                <div class="day-amount">${total > 0 ? fmt(total) : ''}</div>
              `;
              
              cell.onclick = () => showDayDetails(dateStr);

              container.appendChild(cell);

              // Move to next day
              currentDate.setDate(currentDate.getDate() + 1);
            }
        } catch (e) {
            console.error("Supabase month fetch error:", e);
            container.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-muted)">Could not load calendar data.<br><small>${e.message}</small></div>`;
            throw e; // Propagate to renderDashboard
        }
      }

      function changeMonth(direction) {
        if (direction === 0) {
          // Today
          currentViewMonth = new Date();
        } else {
          // Prev or Next
          currentViewMonth.setMonth(currentViewMonth.getMonth() + direction);
        }
        renderCalendar();
      }

      function renderYearlySales() {
        const container = document.getElementById("yearlySales");

        // Group YTD data by year
        const yearlyData = {};

        ytdData.forEach(row => {
          const year = row.entry_date.substring(0, 4); // Extract year from date
          if (!yearlyData[year]) {
            yearlyData[year] = { sales: 0, discounts: 0, pay: 0 };
          }

          const amount = parseFloat(row.amount) || 0;
          yearlyData[year].sales += amount;

          // Only count discount/loyalty once per date
          if (!yearlyData[year][`disc_${row.entry_date}`]) {
            yearlyData[year].discounts += (parseFloat(row.discount) || 0) + (parseFloat(row.loyalty_discount) || 0);
            yearlyData[year][`disc_${row.entry_date}`] = true;
          }

          // Calculate pay (exclude Kim)
          if (row.worker_name.toLowerCase() !== 'kim') {
            const workerPay = Math.round(amount * SERVICE_RATE);
            yearlyData[year].pay += workerPay;
          }
        });

        // Sort years descending (most recent first)
        const years = Object.keys(yearlyData).sort((a, b) => b - a);

        if (years.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No data yet</p>';
          return;
        }

        const currentYear = new Date().getFullYear();
        const currentDate = new Date();

        container.innerHTML = years.map(year => {
          const data = yearlyData[year];
          const grossSales = data.sales - data.discounts;
          const profit = grossSales - data.pay;

          // Calculate projection for current year
          let projectionHTML = '';
          if (parseInt(year) === currentYear) {
            const dayOfYear = Math.floor((currentDate - new Date(currentYear, 0, 0)) / (1000 * 60 * 60 * 24));
            const daysInYear = ((currentYear % 4 === 0 && currentYear % 100 !== 0) || currentYear % 400 === 0) ? 366 : 365;
            const projectedSales = Math.round((grossSales / dayOfYear) * daysInYear);
            const projectedProfit = Math.round((profit / dayOfYear) * daysInYear);

            projectionHTML = `<div class="year-projection">Projected: ${fmt(projectedSales)} (${fmt(projectedProfit)} profit)</div>`;
          }

          return `
            <div class="year-item">
              <div class="year-label">üìÖ ${year}</div>
              <div class="year-stats">
                <div class="year-sales">${fmt(grossSales)}</div>
                <div class="year-profit">Profit: ${fmt(profit)}</div>
                ${projectionHTML}
              </div>
            </div>
          `;
        }).join('');
      }


      function showDayDetails(dateStr) {
        const entry = monthDataCache[dateStr];
        
        // Format date for title
        // Ensure we parse the date string correctly as local date
        const [y, m, d] = dateStr.split('-').map(Number);
        const dateObj = new Date(y, m - 1, d);
        
        const dateTitle = dateObj.toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        document.getElementById('modalDateTitle').textContent = dateTitle;
        
        const modalBody = document.getElementById('modalBody');
        modalBody.innerHTML = '';
        
        let total = 0;
        
        if (entry && entry.incomes && Object.keys(entry.incomes).length > 0) {
          // Sort workers by amount (descending)
          const sortedWorkers = Object.entries(entry.incomes)
            .sort(([,a], [,b]) => b - a);
            
          sortedWorkers.forEach(([worker, amount]) => {
            if (amount > 0) {
              total += amount;
              const item = document.createElement('div');
              item.className = 'worker-item';
              item.innerHTML = `
                <div class="worker-name">${worker}</div>
                <div class="worker-amount">${fmt(amount)}</div>
              `;
              modalBody.appendChild(item);
            }
          });
        } else {
          modalBody.innerHTML = '<div style="text-align:center; color:var(--text-muted); padding:20px;">No sales recorded for this day</div>';
        }
        
        document.getElementById('modalTotalAmount').textContent = fmt(total);
        
        // Setup Edit Button
        const editBtn = document.getElementById('modalEditBtn');
        if(editBtn) {
            editBtn.onclick = () => {
                window.location.href = `dashboard.html?date=${dateStr}`;
            };
        }
        
        // Show modal
        const modal = document.getElementById('dayDetailsModal');
        modal.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }

      function closeModal(event) {
        // If event is provided (click on overlay), only close if it's the overlay itself
        if (event && event.target !== event.currentTarget && event.target.id !== 'dayDetailsModal') return;
        
        const modal = document.getElementById('dayDetailsModal');
        modal.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      }
      
      // Close on Escape key
      // Remove default Escape listener if it conflicts or keep it.
      // Keeping it.
      document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
           closeModal();
        }
      });
    </script>
  </body>
</html>
