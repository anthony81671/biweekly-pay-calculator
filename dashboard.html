<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Pay Calculator - Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --primary: #5856d6;
        --secondary: #007aff;
        --success: #34c759;
        --danger: #ff3b30;
        --warning: #ff9500;
        --background: #f2f2f7;
        --card-bg: #ffffff;
        --text-main: #1a1a1a;
        --text-muted: #8e8e93;
        --border: #d1d1d6;
        --shadow: 0 4px 14px rgba(0, 0, 0, 0.08);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Inter", -apple-system, sans-serif;
        background-color: var(--background);
        color: var(--text-main);
        line-height: 1.5;
        overflow-x: hidden;
      }

      .dashboard-container {
        padding: 24px;
        max-width: 1400px;
        margin: 0 auto;
      }

      /* Header */
      .dashboard-header {
        margin-bottom: 32px;
        text-align: center;
      }

      .dashboard-header h1 {
        font-size: 34px;
        font-weight: 900;
        margin-bottom: 20px;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
      }

      .stat-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
      }

      .stat-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
      }

      .stat-value {
        font-size: 36px;
        font-weight: 900;
        margin-bottom: 4px;
      }

      .stat-change {
        font-size: 14px;
        font-weight: 600;
      }

      .stat-change.positive {
        color: var(--success);
      }

      .stat-change.negative {
        color: var(--danger);
      }

      /* Chart Section */
      .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 32px;
      }

      .chart-card {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }

      .chart-card h3 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
      }


      /* Calendar Grid */
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .month-title {
        font-size: 22px;
        font-weight: 800;
        color: var(--primary);
      }

      .month-nav {
        display: flex;
        gap: 10px;
      }

      .month-nav button {
        padding: 8px 16px;
        background: white;
        border: 2px solid var(--primary);
        color: var(--primary);
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
      }

      .month-nav button:hover {
        background: var(--primary);
        color: white;
      }

      .weekday-headers {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 8px;
      }

      .weekday-header {
        text-align: center;
        font-size: 12px;
        font-weight: 700;
        color: var(--text-muted);
        text-transform: uppercase;
        padding: 8px;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        padding-bottom: 20px;
      }

      .day-cell {
        background: rgba(88, 86, 214, 0.05);
        border-radius: 12px;
        padding: 12px 8px;
        text-align: center;
        border: 2px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        min-height: 80px;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }

      .day-cell:hover {
        border-color: var(--primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(88, 86, 214, 0.2);
      }

      .day-cell.other-month {
        opacity: 0.3;
        background: rgba(0, 0, 0, 0.02);
      }

      .day-cell.has-sales {
        background: linear-gradient(135deg, rgba(88, 86, 214, 0.15), rgba(0, 122, 255, 0.15));
        border-color: rgba(88, 86, 214, 0.3);
      }

      .day-cell.in-period {
        background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(52, 199, 89, 0.05));
        border-color: rgba(52, 199, 89, 0.4);
      }

      .day-cell.in-period.has-sales {
        background: linear-gradient(135deg, rgba(88, 86, 214, 0.25), rgba(0, 122, 255, 0.25));
        border-color: var(--primary);
      }

      .day-cell.selected {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
      }

      .day-number {
        font-size: 18px;
        font-weight: 900;
        margin-bottom: 6px;
      }

      .day-amount {
        font-size: 11px;
        font-weight: 700;
        color: var(--success);
      }

      .day-cell.selected .day-amount {
        color: white;
      }

      .day-cell.no-sales .day-amount {
        color: var(--text-muted);
        font-size: 10px;
      }

      .day-cell.other-month .day-amount {
        display: none;
      }

      /* Yearly Sales Tracker */
      .yearly-sales {
        background: var(--card-bg);
        border-radius: 20px;
        padding: 24px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
      }

      .yearly-sales h3 {
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 20px;
      }

      .year-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        margin-bottom: 12px;
        background: linear-gradient(135deg, rgba(88, 86, 214, 0.05), rgba(0, 122, 255, 0.05));
        border-radius: 12px;
        border: 1px solid rgba(88, 86, 214, 0.2);
      }

      .year-label {
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
      }

      .year-stats {
        text-align: right;
      }

      .year-sales {
        font-size: 24px;
        font-weight: 900;
        color: var(--primary);
      }

      .year-profit {
        font-size: 13px;
        font-weight: 600;
        color: var(--success);
        margin-top: 4px;
      }

      .year-projection {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-muted);
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed rgba(0, 0, 0, 0.1);
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 60px;
        color: var(--text-muted);
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--border);
        border-top: 4px solid var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Quick Actions */
      .quick-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .action-btn {
        padding: 12px 24px;
        border-radius: 12px;
        border: none;
        font-size: 15px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }

      .action-btn.primary {
        background: var(--primary);
        color: white;
      }

      .action-btn.secondary {
        background: white;
        color: var(--primary);
        border: 2px solid var(--primary);
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .action-btn:active {
        transform: scale(0.98);
      }

      /* Responsive */
      @media (max-width: 1024px) {
        .charts-section {
          grid-template-columns: 1fr;
        }

        .stats-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <div class="dashboard-header">
        <h1>üìä Pay Calculator Dashboard</h1>
        <div class="quick-actions">
          <a href="daily-entry.html" class="action-btn primary">üìÖ Quick Entry</a>
          <a href="index.html" class="action-btn primary">‚öôÔ∏è Full App</a>
          <button class="action-btn secondary" onclick="refreshDashboard()">üîÑ Refresh</button>
        </div>
      </div>

      <!-- Key Stats -->
      <div class="stats-grid">
        <div class="stat-card" style="border-left: 4px solid var(--primary);">
          <div class="stat-label">Gross Sales</div>
          <div class="stat-value" id="statGrossSales">$0</div>
          <div class="stat-change" id="statGrossChange">YTD: $0</div>
        </div>

        <div class="stat-card" style="border-left: 4px solid var(--success);">
          <div class="stat-label">Net Income</div>
          <div class="stat-value" id="statNetIncome">$0</div>
          <div class="stat-change" id="statNetChange">YTD: $0</div>
        </div>

        <div class="stat-card" style="border-left: 4px solid var(--secondary);">
          <div class="stat-label">Total Staff Pay</div>
          <div class="stat-value" id="statStaffPay">$0</div>
          <div class="stat-change" id="statStaffChange">YTD: $0</div>
        </div>

        <div class="stat-card" style="border-left: 4px solid var(--warning);">
          <div class="stat-label">Active Workers</div>
          <div class="stat-value" id="statActiveWorkers">0</div>
          <div class="stat-change" id="statTotalDays">0 working days</div>
        </div>
      </div>

      <!-- Charts Section -->
      <div class="charts-section">
        <div class="chart-card">
          <div class="calendar-header">
            <div class="month-title" id="monthTitle">Loading...</div>
            <div class="month-nav">
              <button onclick="changeMonth(-1)">‚Üê Prev</button>
              <button onclick="changeMonth(0)">Today</button>
              <button onclick="changeMonth(1)">Next ‚Üí</button>
            </div>
          </div>
          <div class="weekday-headers">
            <div class="weekday-header">Sun</div>
            <div class="weekday-header">Mon</div>
            <div class="weekday-header">Tue</div>
            <div class="weekday-header">Wed</div>
            <div class="weekday-header">Thu</div>
            <div class="weekday-header">Fri</div>
            <div class="weekday-header">Sat</div>
          </div>
          <div class="calendar-grid" id="calendarGrid">
            <div class="loading">
              <div class="spinner"></div>
              Loading calendar data...
            </div>
          </div>
        </div>

        <div class="yearly-sales">
          <h3>üìä Yearly Sales Tracker</h3>
          <div id="yearlySales">
            <div class="loading">
              <div class="spinner"></div>
              Loading...
            </div>
          </div>
        </div>
      </div>

    </div>

    <script>
      const SB_URL = "https://ijcxddulqsxwfaqfzmhx.supabase.co";
      const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqY3hkZHVscXN4d2ZhcWZ6bWh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjE2MjgsImV4cCI6MjA4Mzk5NzYyOH0.hQeRBk_08FHpc731rimX8KcEapIr5HrezVsJt9onow8";
      const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

      const SERVICE_RATE = 0.55;
      const ANCHOR_DATE = new Date("2026-01-01T00:00:00");

      let currentPeriodDates = [];
      let periodStart = "";
      let cloudCache = {};
      let ytdData = [];
      let currentViewMonth = new Date(); // For calendar navigation
      let monthDataCache = {}; // Cache for monthly data

      const fmt = (num) => new Intl.NumberFormat("en-US", {
        style: "currency",
        currency: "USD",
        maximumFractionDigits: 0,
      }).format(num);

      window.onload = () => {
        initializeDashboard();
      };

      function initializeDashboard() {
        // Set current month for calendar
        currentViewMonth = new Date();

        // Calculate current pay period for stats (optional)
        const today = new Date();
        const snappedStart = getAutoPeriodStart(today);
        periodStart = snappedStart;
        generatePeriod();

        // Load all data
        loadDashboardData();
      }

      function getAutoPeriodStart(targetDate) {
        const t = new Date(targetDate);
        t.setHours(0, 0, 0, 0);
        const diff = t - ANCHOR_DATE;
        const daysSince = Math.floor(diff / (1000 * 60 * 60 * 24));
        let periodIndex = Math.floor(daysSince / 14);
        if (periodIndex < 0) periodIndex = 0;
        const start = new Date(ANCHOR_DATE);
        start.setDate(start.getDate() + periodIndex * 14);
        return start.toISOString().split("T")[0];
      }

      function generatePeriod() {
        currentPeriodDates = [];
        let sd = new Date(periodStart + "T00:00:00");
        for (let i = 0; i < 14; i++) {
          let d = new Date(sd);
          d.setDate(sd.getDate() + i);
          currentPeriodDates.push(d.toISOString().split("T")[0]);
        }
        let ed = new Date(sd);
        ed.setDate(sd.getDate() + 13);

        const opt = { year: "numeric", month: "short", day: "numeric" };
        const rangeText = `${sd.toLocaleDateString("en-US", opt)} - ${ed.toLocaleDateString("en-US", opt)}`;
        document.getElementById("periodLabel").textContent = rangeText;
      }

      async function loadDashboardData() {
        // Fetch period data
        const { data: periodData, error: periodError } = await supabaseClient
          .from("sales_records")
          .select("*")
          .in("entry_date", currentPeriodDates);

        if (periodError) {
          console.error("Error loading period data:", periodError);
          return;
        }

        // Fetch YTD data
        const yearStart = "2026-01-01";
        const periodEnd = currentPeriodDates[currentPeriodDates.length - 1];
        const { data: ytdDataFetch, error: ytdError } = await supabaseClient
          .from("sales_records")
          .select("*")
          .gte("entry_date", yearStart)
          .lte("entry_date", periodEnd);

        if (ytdError) {
          console.error("Error loading YTD data:", ytdError);
          return;
        }

        ytdData = ytdDataFetch || [];

        // Process data
        cloudCache = {};
        const workers = new Set();

        if (periodData) {
          periodData.forEach((row) => {
            workers.add(row.worker_name);
            if (!cloudCache[row.entry_date]) {
              cloudCache[row.entry_date] = { incomes: {}, discount: 0, loyalty: 0 };
            }
            cloudCache[row.entry_date].incomes[row.worker_name] = parseFloat(row.amount) || 0;
            cloudCache[row.entry_date].discount = parseFloat(row.discount) || 0;
            cloudCache[row.entry_date].loyalty = parseFloat(row.loyalty_discount || 0);
          });
        }

        renderDashboard(Array.from(workers));
      }

      function renderDashboard(workers) {
        // Calculate period stats
        let grossSales = 0;
        let totalDiscounts = 0;
        let totalDays = 0;
        let workerStats = {};

        workers.forEach(w => {
          workerStats[w] = { sales: 0, days: 0, pay: 0 };
        });

        currentPeriodDates.forEach(date => {
          const entry = cloudCache[date] || { incomes: {}, discount: 0, loyalty: 0 };
          totalDiscounts += entry.discount + entry.loyalty;

          workers.forEach(w => {
            const income = entry.incomes[w] || 0;
            if (income > 0) {
              workerStats[w].sales += income;
              workerStats[w].days++;
              totalDays++;
            }
            grossSales += income;
          });
        });

        // Calculate pay (excluding Kim)
        let totalStaffPay = 0;
        workers.forEach(w => {
          if (w.toLowerCase() !== 'kim') {
            workerStats[w].pay = Math.round(workerStats[w].sales * SERVICE_RATE);
            totalStaffPay += workerStats[w].pay;
          }
        });

        const netIncome = grossSales - totalDiscounts - totalStaffPay;

        // Calculate YTD stats
        let ytdGross = 0;
        let ytdDisc = 0;
        let ytdPay = 0;

        const sd = new Date(periodStart + "T00:00:00");
        const currentPIdx = Math.floor((sd - ANCHOR_DATE) / (1000 * 60 * 60 * 24 * 14));

        let periods = {};
        ytdData.forEach((row) => {
          const d = new Date(row.entry_date + "T00:00:00");
          const daysSince = Math.floor((d - ANCHOR_DATE) / (1000 * 60 * 60 * 24));
          const pIdx = Math.floor(daysSince / 14);

          if (pIdx >= 0 && pIdx < currentPIdx) {
            if (!periods[pIdx]) periods[pIdx] = { records: [], days: new Set() };
            periods[pIdx].records.push(row);
            periods[pIdx].days.add(row.entry_date);
          }
        });

        Object.keys(periods).forEach((pIdx) => {
          let p = periods[pIdx];
          let pGross = 0, pDisc = 0, pPay = 0;
          let pWorkerSums = {};
          let pDaysSeen = new Set();

          p.records.forEach((r) => {
            let amt = parseFloat(r.amount) || 0;
            pGross += amt;
            pWorkerSums[r.worker_name] = (pWorkerSums[r.worker_name] || 0) + amt;
            if (!pDaysSeen.has(r.entry_date)) {
              pDisc += (parseFloat(r.discount) || 0) + (parseFloat(r.loyalty_discount) || 0);
              pDaysSeen.add(r.entry_date);
            }
          });

          Object.keys(pWorkerSums).forEach((w) => {
            if (w.toLowerCase() !== "kim") {
              pPay += Math.round(pWorkerSums[w] * SERVICE_RATE);
            }
          });

          ytdGross += pGross;
          ytdDisc += pDisc;
          ytdPay += pPay;
        });

        ytdGross += grossSales;
        ytdDisc += totalDiscounts;
        ytdPay += totalStaffPay;

        const ytdNet = ytdGross - ytdDisc - ytdPay;

        // Update stats cards with YTD data
        document.getElementById("statGrossSales").textContent = fmt(ytdGross - ytdDisc);
        document.getElementById("statGrossChange").textContent = `Since Jan 1, 2026`;

        document.getElementById("statNetIncome").textContent = fmt(ytdNet);
        document.getElementById("statNetChange").textContent = `Profit YTD`;

        document.getElementById("statStaffPay").textContent = fmt(ytdPay);
        document.getElementById("statStaffChange").textContent = `All staff YTD`;

        const activeWorkers = workers.filter(w => workerStats[w].days > 0).length;
        document.getElementById("statActiveWorkers").textContent = activeWorkers;
        document.getElementById("statTotalDays").textContent = `Current period: ${totalDays} days`;

        // Render calendar
        renderCalendar();

        // Render yearly sales
        renderYearlySales();
      }

      async function renderCalendar() {
        const container = document.getElementById("calendarGrid");
        container.innerHTML = "";

        // Update month title
        const monthTitle = currentViewMonth.toLocaleDateString("en-US", { month: "long", year: "numeric" });
        document.getElementById("monthTitle").textContent = monthTitle;

        // Get first and last day of the month
        const year = currentViewMonth.getFullYear();
        const month = currentViewMonth.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        // Get starting Sunday (may be from previous month)
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay()); // Go back to Sunday

        // Get ending Saturday (may be from next month)
        const endDate = new Date(lastDay);
        endDate.setDate(endDate.getDate() + (6 - lastDay.getDay())); // Go forward to Saturday

        // Fetch month data
        const startDateStr = startDate.toISOString().split("T")[0];
        const endDateStr = endDate.toISOString().split("T")[0];

        const { data, error } = await supabaseClient
          .from("sales_records")
          .select("*")
          .gte("entry_date", startDateStr)
          .lte("entry_date", endDateStr);

        // Build cache for this month
        monthDataCache = {};
        if (data) {
          data.forEach(row => {
            if (!monthDataCache[row.entry_date]) {
              monthDataCache[row.entry_date] = { incomes: {}, discount: 0, loyalty: 0 };
            }
            monthDataCache[row.entry_date].incomes[row.worker_name] = parseFloat(row.amount) || 0;
            monthDataCache[row.entry_date].discount = parseFloat(row.discount) || 0;
            monthDataCache[row.entry_date].loyalty = parseFloat(row.loyalty_discount || 0);
          });
        }

        // Render calendar cells
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let currentDate = new Date(startDate);
        while (currentDate <= endDate) {
          const dateStr = currentDate.toISOString().split("T")[0];
          const entry = monthDataCache[dateStr] || { incomes: {}, discount: 0, loyalty: 0 };

          let total = 0;
          Object.values(entry.incomes).forEach(val => total += val);

          const isToday = currentDate.getTime() === today.getTime();
          const isCurrentMonth = currentDate.getMonth() === month;
          const inPeriod = currentPeriodDates.includes(dateStr);

          const cell = document.createElement("div");
          cell.className = "day-cell";

          if (!isCurrentMonth) {
            cell.classList.add("other-month");
          }

          if (total > 0) {
            cell.classList.add("has-sales");
          } else {
            cell.classList.add("no-sales");
          }

          if (inPeriod) {
            cell.classList.add("in-period");
          }

          if (isToday) {
            cell.classList.add("selected");
          }

          cell.innerHTML = `
            <div class="day-number">${currentDate.getDate()}</div>
            <div class="day-amount">${total > 0 ? fmt(total) : ''}</div>
          `;

          container.appendChild(cell);

          // Move to next day
          currentDate.setDate(currentDate.getDate() + 1);
        }
      }

      function changeMonth(direction) {
        if (direction === 0) {
          // Today
          currentViewMonth = new Date();
        } else {
          // Prev or Next
          currentViewMonth.setMonth(currentViewMonth.getMonth() + direction);
        }
        renderCalendar();
      }

      function renderYearlySales() {
        const container = document.getElementById("yearlySales");

        // Group YTD data by year
        const yearlyData = {};

        ytdData.forEach(row => {
          const year = row.entry_date.substring(0, 4); // Extract year from date
          if (!yearlyData[year]) {
            yearlyData[year] = { sales: 0, discounts: 0, pay: 0 };
          }

          const amount = parseFloat(row.amount) || 0;
          yearlyData[year].sales += amount;

          // Only count discount/loyalty once per date
          if (!yearlyData[year][`disc_${row.entry_date}`]) {
            yearlyData[year].discounts += (parseFloat(row.discount) || 0) + (parseFloat(row.loyalty_discount) || 0);
            yearlyData[year][`disc_${row.entry_date}`] = true;
          }

          // Calculate pay (exclude Kim)
          if (row.worker_name.toLowerCase() !== 'kim') {
            const workerPay = Math.round(amount * SERVICE_RATE);
            yearlyData[year].pay += workerPay;
          }
        });

        // Sort years descending (most recent first)
        const years = Object.keys(yearlyData).sort((a, b) => b - a);

        if (years.length === 0) {
          container.innerHTML = '<p style="color: var(--text-muted); text-align: center;">No data yet</p>';
          return;
        }

        const currentYear = new Date().getFullYear();
        const currentDate = new Date();

        container.innerHTML = years.map(year => {
          const data = yearlyData[year];
          const grossSales = data.sales - data.discounts;
          const profit = grossSales - data.pay;

          // Calculate projection for current year
          let projectionHTML = '';
          if (parseInt(year) === currentYear) {
            const dayOfYear = Math.floor((currentDate - new Date(currentYear, 0, 0)) / (1000 * 60 * 60 * 24));
            const daysInYear = ((currentYear % 4 === 0 && currentYear % 100 !== 0) || currentYear % 400 === 0) ? 366 : 365;
            const projectedSales = Math.round((grossSales / dayOfYear) * daysInYear);
            const projectedProfit = Math.round((profit / dayOfYear) * daysInYear);

            projectionHTML = `<div class="year-projection">Projected: ${fmt(projectedSales)} (${fmt(projectedProfit)} profit)</div>`;
          }

          return `
            <div class="year-item">
              <div class="year-label">üìÖ ${year}</div>
              <div class="year-stats">
                <div class="year-sales">${fmt(grossSales)}</div>
                <div class="year-profit">Profit: ${fmt(profit)}</div>
                ${projectionHTML}
              </div>
            </div>
          `;
        }).join('');
      }


      function refreshDashboard() {
        loadDashboardData();
      }
    </script>
  </body>
</html>
