<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Sales Entry</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
      :root {
        /* Premium Spa Palette - Warm Stone & Sophisticated Rose */
        --primary: #BE185D;       /* Pink-700 */
        --primary-soft: #FBCFE8;  /* Pink-200 */
        --secondary: #F472B6;     /* Pink-400 */
        --success: #059669;       /* Emerald-600 */
        --danger: #E11D48;        /* Rose-600 */
        --warning: #D97706;       /* Amber-600 */
        
        --background: #FAFAF9;    /* Warm Stone-50 */
        --sidebar-bg: #FFFFFF;    /* Clean White */
        --card-bg: #FFFFFF;
        
        --text-main: #1C1917;     /* Stone-900 */
        --text-muted: #57534E;    /* Stone-600 */
        --border: #E7E5E4;        /* Stone-200 */
        
        --shadow-sm: 0 1px 2px rgba(28, 25, 23, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(28, 25, 23, 0.05), 0 2px 4px -1px rgba(28, 25, 23, 0.03);
        --shadow-lg: 0 10px 15px -3px rgba(190, 24, 93, 0.05), 0 4px 6px -2px rgba(190, 24, 93, 0.025);
        --radius-lg: 16px;
        --radius-xl: 24px;
      }
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--background);
        color: var(--text-main);
        display: flex;
        min-height: 100vh;
        margin: 0;
      }
      
      /* Sidebar */
      .sidebar {
        width: 280px;
        background: var(--sidebar-bg);
        padding: 32px 24px;
        position: fixed;
        height: 100vh;
        border-right: 1px solid var(--border);
      }
      .logo-section {
        text-align: center;
        margin-bottom: 32px;
      }
      .logo-section img {
        width: 120px;
        border-radius: 12px;
        margin-bottom: 16px;
      }
      .logo-section h2 {
          font-family: "Playfair Display", serif;
          font-size: 20px;
          font-weight: 700;
          color: var(--primary);
          margin-bottom: 4px;
          letter-spacing: -0.01em;
      }
      .nav-menu {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .nav-item {
        padding: 14px 20px;
        border-radius: 12px;
        color: var(--text-muted);
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .nav-item:hover {
        background: rgba(0, 0, 0, 0.05);
        color: var(--primary);
      }
      .nav-item.active {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
      }

      .container {
        margin-left: 280px;
        padding: 40px;
        flex: 1;
        max-width: calc(100% - 280px);
      }
      
      header {
        text-align: left;
        margin-bottom: 32px;
        padding: 0;
      }
      
      h1 {
        font-family: "Playfair Display", serif;
        font-size: 32px;
        font-weight: 700;
        text-align: left;
        background: none;
        -webkit-text-fill-color: initial;
        color: var(--text-main);
        letter-spacing: -0.02em;
      }

      @media (max-width: 768px) {
        .sidebar { display: none; }
        .container { margin-left: 0; padding: 20px; max-width: 100%; }
      }
      .card {
        background: var(--card-bg);
        border-radius: var(--radius-xl);
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow-md);
        position: relative;
        transition: all 0.3s ease;
      }
      .card:hover {
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-soft);
      }
      h2 {
        font-family: "Playfair Display", serif;
        font-size: 22px;
        font-weight: 600;
        margin-top: 0;
        margin-bottom: 18px;
        color: var(--primary);
      }
      label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-muted);
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1.5px solid var(--border);
        font-size: 16px;
        font-family: inherit;
        background: white;
        transition: all 0.2s;
      }
      button {
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        font-size: 16px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: 0.2s;
      }
      button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }
      button:active {
        transform: scale(0.97);
      }
      .btn-primary {
        background: var(--primary);
        color: white;
      }
      .btn-secondary {
        background: var(--secondary);
        color: white;
      }
      .btn-success {
        background: var(--success);
        color: white;
      }
      .btn-outline {
        background: transparent;
        border: 2px solid var(--primary);
        color: var(--primary);
      }
      .btn-small {
        padding: 8px 14px;
        font-size: 13px;
        width: auto;
        margin-top: 0;
      }
      .tabs {
        display: flex;
        background: #e5e5ea;
        padding: 5px;
        border-radius: 14px;
        margin-bottom: 24px;
      }
      .tab {
        flex: 1;
        padding: 10px;
        text-align: center;
        font-size: 12px;
        font-weight: 700;
        border-radius: 10px;
        cursor: pointer;
        color: var(--text-muted);
      }
      .tab.active {
        background: white;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        color: var(--primary);
      }
      
      /* Daily View Specific Styles */
      .worker-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
      .worker-name { font-weight: 600; font-size: 14px; }
      .currency-input { position: relative; width: 120px; }
      .currency-input span { position: absolute; left: 10px; top: 10px; color: #888; font-size: 14px; }
      .currency-input input { padding-left: 20px; text-align: right; width: 100%; padding-right: 10px; }
      .summary-box { background: #e5f1ff; border-radius: 12px; padding: 15px; margin-top: 20px; }
      .summary-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
      .summary-row.total { font-weight: 800; border-top: 1px solid #cbdceb; padding-top: 10px; margin-top: 5px; font-size: 16px; color: var(--primary); }
      
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 15px;
      }
      th {
        text-align: left;
        font-size: 11px;
        padding: 10px;
        border-bottom: 2px solid var(--border);
        color: var(--text-muted);
        text-transform: uppercase;
      }
      td {
        padding: 12px 10px;
        border-bottom: 1px solid var(--border);
      }

      /* Layout for Batch Rows */
      .discount-row,
      .batch-row,
      .daily-row-grid {
        display: grid;
        grid-template-columns: 1fr 120px;
        gap: 10px;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px 14px;
        background: rgba(0, 0, 0, 0.03);
        border-radius: 12px;
      }

      /* Hide number input spinners (Up/Down arrows) */
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        appearance: none;
        margin: 0;
      }
      input[type="number"] {
        -moz-appearance: textfield;
        appearance: textfield;
        text-align: right;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.7);
        display: none;
        justify-content: center;
        align-items: center;
        border-radius: 20px;
        z-index: 10;
      }
      .spinner {
        width: 28px;
        height: 28px;
        border: 3.5px solid var(--border);
        border-top: 3.5px solid var(--primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #333;
        color: white;
        padding: 12px 28px;
        border-radius: 40px;
        opacity: 0;
        transition: 0.3s;
        z-index: 2000;
        font-weight: 600;
        text-align: center;
      }
      .sync-status {
        font-size: 11px;
        text-align: center;
        margin-top: -12px;
        margin-bottom: 15px;
        color: var(--success);
        font-weight: 700;
      }
      @media print {
        .card,
        button,
        .tabs,
        header,
        .no-print {
          display: none !important;
        }
        #summarySection {
          display: block !important;
          box-shadow: none;
          border: none;
          background: white;
        }
      }
    </style>
  </head>
  <body>
    <div class="sidebar">
        <div class="logo-section">
            <img src="kntlogo2026.png" alt="K&T Nails">
            <h2>K&T NAILS</h2>
        </div>
        <nav class="nav-menu">
            <a href="index.html" class="nav-item">üè† Dashboard</a>
            <a href="dashboard.html" class="nav-item active">üí∞ Enter Sales</a>
            <a href="business-budget.html" class="nav-item">üìà Budget</a>
            <a href="receipt-list.html" class="nav-item">üìã Business Receipts</a>
            <a href="receipt-scanner.html" class="nav-item">üì∏ Receipt Scanner</a>
        </nav>
    </div>

    <div class="container">
      <header>
        <h1>Sales Entry</h1>
        <div class="sync-status" style="text-align: left; margin-top: 4px;">‚óè Cloud Sync Connected</div>
      </header>

      <div class="card">
        <h2>üìÖ 1. Pay Period</h2>
        <div
          style="
            background: rgba(88, 86, 214, 0.05);
            padding: 16px;
            border-radius: 15px;
            border: 1px solid var(--primary);
          "
        >
          <div style="margin-bottom: 12px">
            <label>Select Date within Period</label>
            <input
              type="date"
              id="periodPicker"
              onchange="handleDateSelect(this.value)"
              style="border-color: var(--primary)"
            />
          </div>
          <div
            style="
              text-align: center;
              padding: 10px;
              background: white;
              border-radius: 10px;
              box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
            "
          >
            <div
              id="periodLabel"
              style="font-weight: 800; color: var(--primary); font-size: 16px"
            >
              Loading Period...
            </div>
            <div
              id="periodDatesSub"
              style="
                font-size: 13px;
                color: var(--text-muted);
                font-weight: 700;
              "
            ></div>
          </div>
        </div>
        <input type="hidden" id="startDate" />
        <div style="text-align: center; margin-top: 10px">
          <button
            class="btn-outline btn-small"
            onclick="resetToCurrentPeriod()"
            style="font-size: 10px; padding: 4px 8px; opacity: 0.7"
          >
            Back to Current Period
          </button>
        </div>
      </div>

      <div class="tabs no-print">
        <div class="tab" id="tabDaily" onclick="switchTab('daily')">
          Daily Entry
        </div>
        <div class="tab active" id="tabWorker" onclick="switchTab('worker')">
          Batch Sales
        </div>
        <div
          class="tab"
          id="tabBatchLoyalty"
          onclick="switchTab('batchLoyalty')"
        >
          Batch Loyalty
        </div>
      </div>

      <!-- DAILY ENTRY VIEW -->
      <div id="viewDaily" class="card" style="display: none">
        <div class="loading-overlay" id="loading-daily">
          <div class="spinner"></div>
        </div>
        <h2>üìÖ Daily Sales Entry</h2>
        
        <div style="margin-bottom: 20px;">
            <label>Select Date</label>
            <input type="date" id="dailyEntryDate" onchange="loadDailyData()">
        </div>

        <div id="dailyWorkerList">
            <!-- Workers populated here -->
        </div>

        <div style="margin-top: 20px; border-top: 1px dashed var(--border); padding-top: 20px;">
            <label>Daily Discount</label>
            <div class="currency-input" style="width: 100%;">
                <span>$</span>
                <input type="number" id="dailyDiscountTotal" placeholder="0.00" oninput="calculateDailyTotal()">
            </div>

            <div class="summary-box">
                <div class="summary-row">
                    <span>Gross Total:</span>
                    <span id="grossTotal">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>- Discount:</span>
                    <span id="discountDisplay" style="color: var(--danger);">$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Net Pay:</span>
                    <span id="netTotal">$0.00</span>
                </div>
            </div>

            <button class="btn-primary" onclick="saveDailyBatch()" style="margin-top: 20px;">Save Daily Entry</button>
        </div>
      </div>

      <!-- BATCH WORKER -->
      <div id="viewWorker" class="card">
        <div class="loading-overlay" id="loading-worker">
          <div class="spinner"></div>
        </div>
        <h2>üë§ Batch Worker Sales</h2>

        <div
          style="
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px dashed var(--border);
          "
        >
          <label style="font-size: 11px">Add New Worker</label>
          <div style="display: flex; gap: 8px">
            <input
              type="text"
              id="newWorkerName"
              placeholder="Name..."
              style="flex: 1"
            />
            <button class="btn-outline btn-small" onclick="addWorker()">
              Add
            </button>
          </div>
          <div id="workerListManage" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 4px;"></div>
        </div>

        <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed var(--border);">
            <label>Bulk Upload (Excel)</label>
            <div style="display: flex; gap: 10px;">
                <input type="file" id="excelUpload" accept=".xlsx, .xls" style="display: none;" onchange="handleExcelUpload(this)">
                <button class="btn-secondary btn-small" onclick="document.getElementById('excelUpload').click()">
                    üìÇ Upload Excel
                </button>
                <span id="uploadStatus" style="font-size: 12px; align-self: center; color: var(--text-muted);"></span>
            </div>
            <div style="font-size: 10px; color: var(--text-muted); margin-top: 4px;">
                Format: Column A = Date, Column B = Amount
            </div>
        </div>

        <label>Select Worker</label
        ><select id="workerSelect" onchange="loadWorkerBatch()"></select>
        <div
          id="batchHeader"
          style="
            display: grid;
            grid-template-columns: 1fr 120px;
            gap: 10px;
            padding: 10px 14px;
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
          "
        >
          <span>Date</span><span>Gross Sale</span>
        </div>
        <div
          id="batchInputs"
          style="margin-top: 0; max-height: 400px; overflow-y: auto"
        ></div>
        <div
          style="
            margin-top: 15px;
            padding: 12px 14px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            font-weight: 800;
            font-size: 15px;
          "
        >
          <span>Running Total:</span>
          <span id="batchRunningTotal">$0.00</span>
        </div>
        <button
          class="btn-success"
          id="btnSaveWorker"
          onclick="saveWorkerBatchToCloud()"
          style="margin-top: 15px"
        >
          Save All Days for Worker
        </button>
      </div>

      <!-- BATCH LOYALTY -->
      <div id="viewBatchLoyalty" class="card" style="display: none">
        <div class="loading-overlay" id="loading-batch-discounts">
          <div class="spinner"></div>
        </div>
        <h2>üè∑Ô∏è Batch Loyalty Discount</h2>
        <div
          style="
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(88, 86, 214, 0.05);
            border-radius: 12px;
          "
        >
          <label>Bulk Paste Loyalty (14 Numbers)</label>
          <textarea
            id="bulkLoyaltyArea"
            placeholder="Paste 14 numbers here..."
            style="height: 60px"
          ></textarea>
          <button
            class="btn-outline btn-small"
            onclick="distributeLoyaltyBulk()"
            style="margin-top: 10px"
          >
            Autofill Loyalty
          </button>
        </div>
        <div
          id="discountBatchInputs"
          style="max-height: 400px; overflow-y: auto"
        ></div>
        <button
          class="btn-success"
          id="btnSaveLoyalty"
          onclick="saveDiscountBatchToCloud()"
        >
          Save All Discounts to Cloud
        </button>
      </div>

      <div class="card no-print">
        <h2>üìä 3. Biweekly Summary</h2>
        <div style="margin-bottom: 15px">
          <label>Select Date within Period</label>
          <input
            type="date"
            id="summaryPeriodPicker"
            onchange="handleSummaryDateSelect(this.value)"
          />
        </div>
        <button
          class="btn-secondary"
          id="btn-gen-report"
          onclick="generateReportFromSummary()"
        >
          Generate Final Report
        </button>
      </div>

      <!-- EXCEL PREVIEW MODAL -->
      <div id="excelPreviewModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;">
          <div class="card" style="width: 95%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column;">
              <h2>üìã Preview Import</h2>
              <div style="margin-bottom: 10px; font-size: 12px; color: var(--text-muted);">
                  Showing all columns found in the file. Only <b>Date</b> and <b>Amount</b> (auto-detected) will be saved.
              </div>
              <div style="flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 8px;">
                  <table style="width: 100%; border-collapse: collapse; font-size: 12px; min-width: 400px;">
                      <thead style="background: #f5f5f5; position: sticky; top: 0;" id="previewTableHead">
                      </thead>
                      <tbody id="previewTableBody"></tbody>
                  </table>
              </div>
              <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                  <button class="btn-outline" onclick="closePreviewModal()">Cancel</button>
                  <button class="btn-success" onclick="confirmExcelUpload()">Confirm & Save</button>
              </div>
          </div>
      </div>

      <div id="summarySection" class="card" style="display: none">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
          "
        >
          <div>
            <h3>Pay Report</h3>
            <span
              id="reportPeriodText"
              style="
                font-size: 14px;
                font-weight: 600;
                color: var(--text-muted);
              "
            ></span>
          </div>
          <button
            class="btn-outline btn-small no-print"
            onclick="window.print()"
          >
            Print
          </button>
        </div>
        <table id="summaryTable">
          <thead>
            <tr>
              <th>Worker</th>
              <th style="text-align: right">Total Sales</th>
              <th style="text-align: right">Days</th>
              <th style="text-align: right">Pay</th>
              <th style="text-align: right">W2</th>
              <th style="text-align: right">Cash</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
          <tfoot>
            <tr style="font-weight: 800; background: #f2f2f7">
              <td>TOTAL</td>
              <td id="totGross" style="text-align: right">0</td>
              <td id="totDays" style="text-align: right">0</td>
              <td id="totPay" style="text-align: right">0</td>
              <td id="totW2" style="text-align: right">0</td>
              <td id="totCash" style="text-align: right">0</td>
            </tr>
          </tfoot>
        </table>

        <div
          style="
            margin-top: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 15px;
            border: 1px solid var(--border);
          "
        >
          <h3
            style="
              margin-top: 0;
              font-size: 16px;
              border-bottom: 1px solid var(--border);
              padding-bottom: 10px;
            "
          >
            üìâ Financial Summary
          </h3>

          <div
            style="
              display: grid;
              grid-template-columns: 1fr 100px 120px;
              gap: 10px;
              font-size: 11px;
              font-weight: 700;
              color: var(--text-muted);
              text-transform: uppercase;
              margin-bottom: 10px;
              padding: 0 5px;
            "
          >
            <span>Metric</span><span style="text-align: right">Biweekly</span
            ><span style="text-align: right">YTD TOTAL</span>
          </div>

          <!-- Total Sales -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 100px 120px;
              gap: 10px;
              margin-bottom: 8px;
              padding: 0 5px;
            "
          >
            <span>Total Sales:</span>
            <span id="finTotalSale" style="text-align: right; font-weight: 700"
              >$0</span
            >
            <span
              id="ytdTotalSale"
              style="text-align: right; font-weight: 700; opacity: 0.8"
              >$0</span
            >
          </div>

          <!-- Discounts -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 100px 120px;
              gap: 10px;
              margin-bottom: 8px;
              padding: 0 5px;
            "
          >
            <span>- Discounts:</span>
            <span
              id="finDiscounts"
              style="text-align: right; font-weight: 700; color: var(--danger)"
              >$0</span
            >
            <span
              id="ytdDiscounts"
              style="
                text-align: right;
                font-weight: 700;
                color: var(--danger);
                opacity: 0.8;
              "
              >$0</span
            >
          </div>

          <!-- Gross Sale -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 100px 120px;
              gap: 10px;
              margin-bottom: 12px;
              padding: 8px 5px 0;
              border-top: 1px solid var(--border);
            "
          >
            <span style="font-weight: 800">= Gross Sale:</span>
            <span
              id="finGrossSale"
              style="text-align: right; font-weight: 800; color: var(--primary)"
              >$0</span
            >
            <span
              id="ytdGrossSale"
              style="
                text-align: right;
                font-weight: 800;
                color: var(--primary);
                opacity: 0.8;
              "
              >$0</span
            >
          </div>

          <!-- Staff Pay -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 100px 120px;
              gap: 10px;
              margin-bottom: 8px;
              padding: 0 5px;
            "
          >
            <span>- Total Staff Pay:</span>
            <span
              id="finTotalPay"
              style="text-align: right; font-weight: 700; color: var(--danger)"
              >$0</span
            >
            <span
              id="ytdTotalPay"
              style="
                text-align: right;
                font-weight: 700;
                color: var(--danger);
                opacity: 0.8;
              "
              >$0</span
            >
          </div>

          <!-- Net Sale -->
          <div
            style="
              display: grid;
              grid-template-columns: 1fr 100px 120px;
              gap: 10px;
              padding: 10px 5px 0;
              border-top: 2px solid var(--primary);
              font-size: 16px;
            "
          >
            <span style="font-weight: 900">NET SALE:</span>
            <span
              id="finNetSale"
              style="text-align: right; font-weight: 900; color: var(--success)"
              >$0</span
            >
            <span
              id="ytdNetSale"
              style="text-align: right; font-weight: 900; color: var(--success)"
              >$0</span
            >
          </div>

          <div
            style="
              margin-top: 15px;
              padding-top: 10px;
              border-top: 1px dashed var(--border);
              font-size: 14px;
              opacity: 0.8;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 5px;
              "
            >
              <span>Projected Annual Sales:</span
              ><span
                id="finAnnualSales"
                style="font-weight: 700; color: var(--text-main)"
                >$0</span
              >
            </div>
            <div style="display: flex; justify-content: space-between">
              <span>Projected Annual Net:</span
              ><span
                id="finAnnualNet"
                style="font-weight: 700; color: var(--success)"
                >$0</span
              >
            </div>
          </div>

          <div style="margin-top: 15px; border-top: 1px solid var(--border); padding-top: 10px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="color: var(--text-muted); text-transform: uppercase;">
                  <th style="text-align: left; padding: 4px;">Worker</th>
                  <th style="text-align: right; padding: 4px;">YTD Sales</th>
                  <th style="text-align: right; padding: 4px;">Avg/Day</th>
                  <th style="text-align: right; padding: 4px;">YTD Pay</th>
                  <th style="text-align: right; padding: 4px;">YTD Avg</th>
                </tr>
              </thead>
              <tbody id="workerStatsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div id="toast" class="toast">Data Synced!</div>

    <script>
      const SB_URL = "https://ijcxddulqsxwfaqfzmhx.supabase.co";
      const SB_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlqY3hkZHVscXN4d2ZhcWZ6bWh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0MjE2MjgsImV4cCI6MjA4Mzk5NzYyOH0.hQeRBk_08FHpc731rimX8KcEapIr5HrezVsJt9onow8";
      const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

      const DEFAULT_WORKERS = [
        "Tammy",
        "Linh",
        "Van",
        "Thuy (Lee)",
        "Tuyen (Bella)",
        "Kim",
      ];
      let workers =
        (JSON.parse(localStorage.getItem("savedWorkers")) || DEFAULT_WORKERS).filter(
          (w) => w !== "Kim Tran"
        );
      
      // Ensure Kim is always last in the list
      const ensureKimLast = (list) => {
        const kimIndex = list.findIndex(w => w.toLowerCase() === 'kim');
        if (kimIndex > -1 && kimIndex < list.length - 1) {
           const kim = list.splice(kimIndex, 1)[0];
           list.push(kim);
        }
        return list;
      };
      
      workers = ensureKimLast(workers);

      let periodStart = localStorage.getItem("periodStart") || "";
      let currentPeriodDates = [];
      let cloudCache = {};

      const SERVICE_RATE = 0.55; // 55% commission

      const ANCHOR_DATE = new Date("2026-01-01T00:00:00");

      window.onload = () => {
        refreshWorkerUI();

        // Check for date passed in URL
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('date');

        // Auto-calculate current period on start
        let saved = localStorage.getItem("periodStart");
        if (saved) {
          document.getElementById("startDate").value = saved;
          document.getElementById("periodPicker").value = saved;
        } else {
          resetToCurrentPeriod();
        }
        generatePeriod();
        switchTab("daily");

        // If a specific date was passed, set it in the daily entry
        if (dateParam) {
          document.getElementById("dailyEntryDate").value = dateParam;
          loadDailyData();
        }
      };

      function resetToCurrentPeriod() {
        const startStr = getAutoPeriodStart(new Date());
        document.getElementById("startDate").value = startStr;
        document.getElementById("periodPicker").value = new Date()
          .toISOString()
          .split("T")[0];
        generatePeriod();
      }

      function handleDateSelect(val) {
        if (!val) return;
        const snappedStart = getAutoPeriodStart(new Date(val + "T00:00:00"));
        document.getElementById("startDate").value = snappedStart;
        document.getElementById("periodPicker").value = val;
        document.getElementById("summaryPeriodPicker").value = val;
        generatePeriod();
      }

      function handleSummaryDateSelect(val) {
        handleDateSelect(val);
        generateReportFromSummary();
      }

      function getAutoPeriodStart(targetDate) {
        const t = new Date(targetDate);
        t.setHours(0, 0, 0, 0);
        const diff = t - ANCHOR_DATE;
        const daysSince = Math.floor(diff / (1000 * 60 * 60 * 24));
        let periodIndex = Math.floor(daysSince / 14);
        if (periodIndex < 0) periodIndex = 0; // Don't go before 2026
        const start = new Date(ANCHOR_DATE);
        start.setDate(start.getDate() + periodIndex * 14);
        return start.toISOString().split("T")[0];
      }

      function refreshWorkerUI() {
        localStorage.setItem("savedWorkers", JSON.stringify(workers));
        const ws = document.getElementById("workerSelect");
        if (ws) {
          ws.innerHTML = '<option value="">-- Worker --</option>';
          workers.forEach((w) => {
            let opt = document.createElement("option");
            opt.value = w;
            opt.textContent = w;
            ws.appendChild(opt);
          });
        }

        // Add a simple worker management list below the add button if needed
        const manageContainer = document.getElementById("workerListManage");
        if (manageContainer) {
          manageContainer.innerHTML = "";
        }
      }

      function removeWorker(name) {
        if (!confirm(`Remove ${name} from local list?`)) return;
        workers = workers.filter((w) => w !== name);
        refreshWorkerUI();
        showToast("Removed " + name);
      }

      function addWorker() {
        let name = document.getElementById("newWorkerName").value.trim();
        if (!name || workers.includes(name)) return;
        workers.push(name);
        workers = ensureKimLast(workers); // Re-sort to keep Kim last
        document.getElementById("newWorkerName").value = "";
        refreshWorkerUI();
        showToast("Added " + name);
      }

      function generatePeriod() {
        let start = document.getElementById("startDate").value;
        if (!start) return;
        periodStart = start;
        localStorage.setItem("periodStart", start);
        currentPeriodDates = [];
        let sd = new Date(start + "T00:00:00");
        for (let i = 0; i < 14; i++) {
          let d = new Date(sd);
          d.setDate(sd.getDate() + i);
          currentPeriodDates.push(d.toISOString().split("T")[0]);
        }
        let ed = new Date(sd);
        ed.setDate(sd.getDate() + 13);

        // Update UI Labels with Year
        const opt = { year: "numeric", month: "short", day: "numeric" };
        const rangeText = `${sd.toLocaleDateString(
          "en-US",
          opt
        )} - ${ed.toLocaleDateString("en-US", opt)}`;
        document.getElementById("periodLabel").textContent =
          "Pay Period " +
          (Math.floor((sd - ANCHOR_DATE) / (1000 * 60 * 60 * 24 * 14)) + 1);
        document.getElementById("periodDatesSub").textContent = rangeText;
        document.getElementById("reportPeriodText").textContent = rangeText;

        prefetchPeriodData();
      }

      async function prefetchPeriodData() {
        if (!currentPeriodDates.length) return;
        const { data, error } = await supabaseClient
          .from("sales_records")
          .select("*")
          .in("entry_date", currentPeriodDates);
        if (error) {
          console.error("Cloud Error:", error);
          return;
        }

        let dbWorkersFound = false;
        cloudCache = {};
        if (data) {
          data.forEach((row) => {
            // Dynamic Discovery: If DB has a worker not in our list, add them!
            if (row.worker_name && !workers.includes(row.worker_name)) {
              workers.push(row.worker_name);
              dbWorkersFound = true;
            }

            if (!cloudCache[row.entry_date])
              cloudCache[row.entry_date] = {
                incomes: {},
                discount: 0,
                loyalty: 0,
              };
            cloudCache[row.entry_date].incomes[row.worker_name] = Math.round(
              parseFloat(row.amount) || 0
            );
            cloudCache[row.entry_date].discount = Math.round(
              parseFloat(row.discount) || 0
            );
            cloudCache[row.entry_date].loyalty = Math.round(
              parseFloat(row.loyalty_discount || 0)
            );
          });
        }
        if (dbWorkersFound) refreshWorkerUI();
        loadDayFromCloud();
      }

      function switchTab(mode) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .getElementById("tabDaily")
          .classList.toggle("active", mode === "daily");
        document
          .getElementById("tabWorker")
          .classList.toggle("active", mode === "worker");
        document
          .getElementById("tabBatchLoyalty")
          .classList.toggle("active", mode === "batchLoyalty");
          
        document.getElementById("viewDaily").style.display =
          mode === "daily" ? "block" : "none";
        document.getElementById("viewWorker").style.display =
          mode === "worker" ? "block" : "none";
        document.getElementById("viewBatchLoyalty").style.display =
          mode === "batchLoyalty" ? "block" : "none";
          
        if (mode === "worker") loadWorkerBatch();
        if (mode === "batchLoyalty") loadDiscountBatch();
        if (mode === "daily") {
           // Default to today or selected period start if today is out of range (optional, for now just today)
           if(!document.getElementById("dailyEntryDate").value) {
               document.getElementById("dailyEntryDate").valueAsDate = new Date();
           }
           loadDailyData();
        }
      }
      
      async function loadDailyData() {
        const date = document.getElementById("dailyEntryDate").value;
        if(!date) return;
        
        document.getElementById("loading-daily").style.display = "flex";
        
        // Ensure workers list is up to date in UI
        const listContainer = document.getElementById("dailyWorkerList");
        listContainer.innerHTML = "";
        
        // We need to fetch data for this specific date
        // Check cloudCache first? It might not have this date if we haven't loaded the period.
        // Safer to just fetch for this date specifically to be accurate.
        
        const { data, error } = await supabaseClient
          .from("sales_records")
          .select("*")
          .eq("entry_date", date);
          
        let dayData = {};
        let dayDiscount = 0;
        
        if (data) {
           data.forEach(r => {
               dayData[r.worker_name] = r.amount;
               // Discount is stored per row, but should be same for all. Take first non-zero.
               if(r.discount) dayDiscount = r.discount;
           });
        }
        
        workers.forEach(name => {
            const val = dayData[name] !== undefined ? dayData[name] : "";
            const row = document.createElement("div");
            row.className = "worker-row";
            row.innerHTML = `
                <span class="worker-name">${name}</span>
                <div class="currency-input">
                    <span>$</span>
                    <input type="number" class="income-input-daily" data-worker="${name}" value="${val}" placeholder="0" oninput="calculateDailyTotal()">
                </div>
            `;
            listContainer.appendChild(row);
        });
        
        document.getElementById("dailyDiscountTotal").value = dayDiscount > 0 ? dayDiscount : "";
        calculateDailyTotal();
        document.getElementById("loading-daily").style.display = "none";
      }

      function calculateDailyTotal() {
        let gross = 0;
        document.querySelectorAll('.income-input-daily').forEach(input => {
            const val = parseFloat(input.value);
            if (!isNaN(val)) gross += val;
        });

        let discount = parseFloat(document.getElementById('dailyDiscountTotal').value);
        if (isNaN(discount)) discount = 0;

        const net = gross - discount;

        document.getElementById('grossTotal').innerText = fmt(gross);
        document.getElementById('discountDisplay').innerText = '-' + fmt(discount);
        document.getElementById('netTotal').innerText = fmt(net);
      }
      
      async function saveDailyBatch() {
        const date = document.getElementById("dailyEntryDate").value;
        if (!date) return;
        
        document.getElementById("loading-daily").style.display = "flex";
        
        let discount = parseFloat(document.getElementById('dailyDiscountTotal').value) || 0;
        
        // We need to preserve Loyalty if it exists!
        // Fetch existing for this date to get loyalty?
        // Or assume we just upsert and don't touch loyalty column? 
        // Supabase upsert replaces the row. If we omit loyalty_discount, it might set to NULL or DEFAULT.
        // We must fetch first to be safe, or use the data we already fetched in loadDailyData (but that might be stale).
        // Best approach: Fetch current state, merge, then save.
        
        const { data: existingData } = await supabaseClient
          .from("sales_records")
          .select("worker_name, loyalty_discount")
          .eq("entry_date", date);
          
        let loyaltyMap = {};
        if(existingData) {
            existingData.forEach(r => loyaltyMap[r.worker_name] = r.loyalty_discount);
        }

        let records = [];
        document.querySelectorAll('.income-input-daily').forEach(input => {
            let wName = input.dataset.worker;
            let amount = parseFloat(input.value) || 0;
            // Only save if amount > 0 OR if there was previous data (to clear it)
            // Actually better to save 0 to be explicit.
            
            records.push({
                entry_date: date,
                worker_name: wName,
                amount: amount,
                discount: discount,
                loyalty_discount: loyaltyMap[wName] || 0
            });
        });
        
        const { error } = await supabaseClient
          .from("sales_records")
          .upsert(records, { onConflict: "entry_date, worker_name" });
          
        if (error) {
           alert("Error saving: " + error.message);
        } else {
           // Update cache if we are in the same period
           if(currentPeriodDates.includes(date)) {
               // Update cache manually
               if (!cloudCache[date]) cloudCache[date] = { incomes: {}, discount: 0, loyalty: 0 };
               records.forEach(r => {
                   cloudCache[date].incomes[r.worker_name] = r.amount;
                   cloudCache[date].discount = r.discount;
                   cloudCache[date].loyalty = r.loyalty_discount;
               });
           }

           // Move to next day automatically
           const d = new Date(date + "T00:00:00");
           d.setDate(d.getDate() + 1);
           const y = d.getFullYear();
           const m = String(d.getMonth() + 1).padStart(2, '0');
           const day = String(d.getDate()).padStart(2, '0');
           const nextDate = `${y}-${m}-${day}`;

           // Format date for display
           const nextDateObj = new Date(nextDate + "T00:00:00");
           const displayDate = nextDateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

           showToast(`Saved! Moving to ${displayDate}...`);

           // Small delay to show the message before advancing
           setTimeout(() => {
               document.getElementById("dailyEntryDate").value = nextDate;
               loadDailyData();
           }, 800);
        }
        document.getElementById("loading-daily").style.display = "none";
      }

      async function loadDayFromCloud() {
        let date = document.getElementById("entryDate").value;
        let data = cloudCache[date] || { incomes: {}, discount: 0, loyalty: 0 };
        document
          .querySelectorAll(".income-input")
          .forEach(
            (inp) =>
              (inp.value =
                data.incomes[inp.dataset.worker] !== undefined
                  ? Math.round(data.incomes[inp.dataset.worker])
                  : "")
          );
        document.getElementById("dailyDiscount").value = Math.round(
          data.discount || 0
        );
        document.getElementById("loyaltyDiscount").value = Math.round(
          data.loyalty || 0
        );
      }

      async function saveDayToCloud() {
        let date = document.getElementById("entryDate").value;
        if (!date) return;
        document.getElementById("loading-day").style.display = "flex";
        let records = workers.map((w) => ({
          entry_date: date,
          worker_name: w,
          amount:
            parseFloat(
              document.querySelector(`.income-input[data-worker="${w}"]`).value
            ) || 0,
          discount:
            parseFloat(document.getElementById("dailyDiscount").value) || 0,
          loyalty_discount:
            parseFloat(document.getElementById("loyaltyDiscount").value) || 0,
        }));
        const { error } = await supabaseClient
          .from("sales_records")
          .upsert(records, { onConflict: "entry_date, worker_name" });
        if (error) {
          alert("Save Error: " + error.message);
        } else {
          if (!cloudCache[date])
            cloudCache[date] = { incomes: {}, discount: 0, loyalty: 0 };
          records.forEach((r) => {
            cloudCache[date].incomes[r.worker_name] = r.amount;
          });
          cloudCache[date].discount = records[0].discount;
          cloudCache[date].loyalty = records[0].loyalty_discount;
          showToast("Day Saved!");
        }
        document.getElementById("loading-day").style.display = "none";
      }

      async function loadWorkerBatch() {
        let w = document.getElementById("workerSelect").value;
        if (!w || !currentPeriodDates.length) return;
        document.getElementById("loading-worker").style.display = "flex";
        await prefetchPeriodData();
        const container = document.getElementById("batchInputs");
        container.innerHTML = "";
        currentPeriodDates.forEach((date) => {
          let val =
            cloudCache[date] && cloudCache[date].incomes[w] !== undefined
              ? Math.round(cloudCache[date].incomes[w])
              : "";
          let label = new Date(date + "T00:00:00").toLocaleDateString("en-US", {
            weekday: "short",
            month: "numeric",
            day: "numeric",
          });
          let div = document.createElement("div");
          div.className = "batch-row";
          div.innerHTML = `<label style="font-weight:600; font-size:14px;">${label}</label>
        <input type="number" class="w-batch-input" data-date="${date}" value="${val}" placeholder="$0" oninput="updateBatchTotal()">`;
          container.appendChild(div);
        });
        updateBatchTotal();
        document.getElementById("loading-worker").style.display = "none";
      }

      function updateBatchTotal() {
        let total = 0;
        document.querySelectorAll(".w-batch-input").forEach((inp) => {
          total += parseFloat(inp.value) || 0;
        });
        document.getElementById("batchRunningTotal").textContent =
          "$" + total.toFixed(2);
      }

      async function saveWorkerBatchToCloud() {
        let w = document.getElementById("workerSelect").value;
        if (!w) return;
        document.getElementById("loading-worker").style.display = "flex";
        let records = Array.from(
          document.querySelectorAll(".w-batch-input")
        ).map((inp) => {
          let date = inp.dataset.date;
          return {
            entry_date: date,
            worker_name: w,
            amount: parseFloat(inp.value) || 0,
            discount: (cloudCache[date] && cloudCache[date].discount) || 0,
            loyalty_discount:
              (cloudCache[date] && cloudCache[date].loyalty) || 0,
          };
        });
        const { error } = await supabaseClient
          .from("sales_records")
          .upsert(records, { onConflict: "entry_date, worker_name" });
        if (error) {
          alert("Batch Worker Error: " + error.message);
        } else {
          records.forEach((r) => {
            if (!cloudCache[r.entry_date])
              cloudCache[r.entry_date] = {
                incomes: {},
                discount: 0,
                loyalty: 0,
              };
            cloudCache[r.entry_date].incomes[w] = r.amount;
          });
          showToast("Worker Sales Saved!");
        }
        document.getElementById("loading-worker").style.display = "none";
      }

      async function loadDiscountBatch() {
        const container = document.getElementById("discountBatchInputs");
        container.innerHTML = "";
        if (!currentPeriodDates.length) return;
        document.getElementById("loading-batch-discounts").style.display =
          "flex";
        await prefetchPeriodData();
        currentPeriodDates.forEach((date) => {
          let data = cloudCache[date] || { discount: 0, loyalty: 0 };
          let label = new Date(date + "T00:00:00").toLocaleDateString("en-US", {
            weekday: "short",
            month: "numeric",
            day: "numeric",
          });
          let div = document.createElement("div");
          div.className = "discount-row";
          div.innerHTML = `<span style="font-weight:600; font-size:14px;">${label}</span><input type="number" class="l-batch-val" data-date="${date}" value="${data.loyalty}">`;
          container.appendChild(div);
        });
        document.getElementById("loading-batch-discounts").style.display =
          "none";
      }

      async function saveDiscountBatchToCloud() {
        let btn = document.getElementById("btnSaveLoyalty");
        btn.disabled = true;
        document.getElementById("loading-batch-discounts").style.display =
          "flex";
        await prefetchPeriodData();
        let records = [];
        currentPeriodDates.forEach((date) => {
          let lInp = document.querySelector(
            `.l-batch-val[data-date="${date}"]`
          );
          let lVal = lInp ? parseFloat(lInp.value) || 0 : 0;
          let dVal = (cloudCache[date] && cloudCache[date].discount) || 0;
          workers.forEach((w) => {
            records.push({
              entry_date: date,
              worker_name: w,
              amount: (cloudCache[date] && cloudCache[date].incomes[w]) || 0,
              discount: dVal,
              loyalty_discount: lVal,
            });
          });
          if (!cloudCache[date])
            cloudCache[date] = { incomes: {}, discount: 0, loyalty: 0 };
          cloudCache[date].loyalty = lVal;
        });
        const { error } = await supabaseClient
          .from("sales_records")
          .upsert(records, { onConflict: "entry_date, worker_name" });
        if (error) {
          alert("Loyalty Save Error: " + error.message);
        } else {
          showToast("Loyalty Updated!");
        }
        document.getElementById("loading-batch-discounts").style.display =
          "none";
        btn.disabled = false;
      }



      /* EXCEL LOGIC */
      let parsedExcelData = [];
      let parsedHeaders = [];
      let detectedMapping = { date: -1, amount: -1, worker: -1 };

      function handleExcelUpload(input) {
          const file = input.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: 'array' });
              const firstSheetName = workbook.SheetNames[0];
              const worksheet = workbook.Sheets[firstSheetName];
              
              // Get all data including headers
              const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Array of Arrays
              
              if (!json || json.length === 0) {
                  alert("File is empty");
                  return;
              }

              parsedExcelData = [];
              parsedHeaders = [];
              
              // Attempt to detect header row
              let startIdx = 0;
              let firstRow = json[0];
              
              // Simple Header Detection
              if (firstRow && firstRow.some(c => typeof c === 'string')) {
                  parsedHeaders = firstRow.map((h, i) => h || `Col ${i+1}`);
                  startIdx = 1;
              } else {
                  parsedHeaders = firstRow.map((_, i) => `Col ${i+1}`);
                  startIdx = 0;
              }
              
              // Analyze columns for Date/Amount/Worker suggestions
              detectedMapping = { date: 0, amount: 1, worker: -1 }; // Default defaults
              
              parsedHeaders.forEach((h, i) => {
                  const lower = String(h).toLowerCase();
                  if (lower.includes('date') || lower.includes('day')) detectedMapping.date = i;
                  if (lower.includes('amount') || lower.includes('total') || lower.includes('cost') || lower.includes('price')) detectedMapping.amount = i;
                  if (lower.includes('worker') || lower.includes('name') || lower.includes('employee') || lower.includes('staff')) detectedMapping.worker = i;
              });

              for (let i = startIdx; i < json.length; i++) {
                  const row = json[i];
                  if (!row || row.length === 0) continue;
                  // Store raw row for later mapped parsing
                  parsedExcelData.push({ _rawRow: row });
              }
              
              if (parsedExcelData.length > 0) {
                  showPreviewModal();
              } else {
                  alert("No data found to import.");
              }
              
              input.value = ""; 
          };
          reader.readAsArrayBuffer(file);
      }

      function showPreviewModal() {
          const contentDiv = document.querySelector("#excelPreviewModal .card");
          
          // Inject Column Mappers if not exists
          let mapperDiv = document.getElementById("columnMappers");
          if (!mapperDiv) {
              mapperDiv = document.createElement("div");
              mapperDiv.id = "columnMappers";
              mapperDiv.style.marginBottom = "15px";
              mapperDiv.style.padding = "10px";
              mapperDiv.style.background = "#fff"; // bg
              mapperDiv.style.border = "1px solid var(--primary)";
              mapperDiv.style.borderRadius = "8px";
              mapperDiv.style.display = "flex";
              mapperDiv.style.gap = "15px";
              mapperDiv.style.flexWrap = "wrap";
              
              // Insert after title
              contentDiv.insertBefore(mapperDiv, contentDiv.children[2]); // After description
          }
          
          // Render Mappers
          const options = parsedHeaders.map((h, i) => `<option value="${i}">${h}</option>`).join("");
          const noneOpt = `<option value="-1">-- None (Use Dropdown) --</option>`;
          
          mapperDiv.innerHTML = `
             <div style="flex: 1;">
               <label style="font-size:10px; font-weight:700;">Worker Column</label>
               <select id="mapWorker" onchange="refreshPreviewTable()" style="width:100%">${noneOpt}${options}</select>
             </div>
             <div style="flex: 1;">
               <label style="font-size:10px; font-weight:700;">Date Column</label>
               <select id="mapDate" onchange="refreshPreviewTable()" style="width:100%">${options}</select>
             </div>
             <div style="flex: 1;">
               <label style="font-size:10px; font-weight:700;">Amount Column</label>
               <select id="mapAmount" onchange="refreshPreviewTable()" style="width:100%">${options}</select>
             </div>
          `;
          
          // Set Defaults
          document.getElementById("mapWorker").value = detectedMapping.worker;
          document.getElementById("mapDate").value = detectedMapping.date > -1 ? detectedMapping.date : 0;
          document.getElementById("mapAmount").value = detectedMapping.amount > -1 ? detectedMapping.amount : 1;

          refreshPreviewTable();
          
          document.getElementById("excelPreviewModal").style.display = "flex";
      }

      function refreshPreviewTable() {
         const wIdx = parseInt(document.getElementById("mapWorker").value);
         const dIdx = parseInt(document.getElementById("mapDate").value);
         const aIdx = parseInt(document.getElementById("mapAmount").value);
         
         const thead = document.getElementById("previewTableHead");
         const tbody = document.getElementById("previewTableBody");
         thead.innerHTML = "";
         tbody.innerHTML = "";
         
         // Headers
         let hRow = document.createElement("tr");
         parsedHeaders.forEach((h, i) => {
             let th = document.createElement("th");
             th.style.padding = "8px";
             th.style.textAlign = "left";
             th.style.borderBottom = "2px solid #ddd";
             // Highlight mapped columns
             if (i === wIdx) th.style.background = "#eef2ff"; // Indigo
             if (i === dIdx) th.style.background = "#f0fdf4"; // Green
             if (i === aIdx) th.style.background = "#fffbeb"; // Yellow
             th.textContent = h;
             hRow.appendChild(th);
         });
         thead.appendChild(hRow);

         // Rows
         let limit = 50; // Performance limit for preview
         parsedExcelData.slice(0, limit).forEach(item => {
             let row = item._rawRow;
             let tr = document.createElement("tr");
             
             parsedHeaders.forEach((_, i) => {
                  let val = row[i];
                  let displayVal = val !== undefined ? val : "";
                  
                  // Format checks
                  if (i === dIdx) {
                      // Attempt parse date for preview
                      displayVal = parseExcelDateSafe(val);
                  }
                  if (i === aIdx) {
                      if(typeof val === 'number') displayVal = fmt(val);
                  }
                  
                  let td = document.createElement("td");
                  td.style.padding = "6px 8px";
                  td.style.borderBottom = "1px solid #eee";
                  if (i === aIdx) td.style.textAlign = "right";
                  if (i === wIdx || i === dIdx || i === aIdx) td.style.fontWeight = "600";
                  
                  td.textContent = displayVal;
                  tr.appendChild(td);
             });
             tbody.appendChild(tr);
         });
         
         if(parsedExcelData.length > limit) {
             let tr = document.createElement("tr");
             tr.innerHTML = `<td colspan="${parsedHeaders.length}" style="padding:10px;text-align:center;color:#666;">... and ${parsedExcelData.length - limit} more rows</td>`;
             tbody.appendChild(tr);
         }
      }

      function parseExcelDateSafe(val) {
          if (typeof val === 'number') {
              const d = new Date(Math.round((val - 25569)*86400*1000));
              d.setMinutes(d.getMinutes() + d.getTimezoneOffset());
              return d.toISOString().split("T")[0];
          } else if (typeof val === 'string') {
              const d = new Date(val);
              if (!isNaN(d.getTime())) return d.toISOString().split("T")[0];
          }
          return val; // Fallback
      }

      async function confirmExcelUpload() {
          const globalWorker = document.getElementById("workerSelect").value;
          
          const wIdx = parseInt(document.getElementById("mapWorker").value);
          const dIdx = parseInt(document.getElementById("mapDate").value);
          const aIdx = parseInt(document.getElementById("mapAmount").value);

          // Validation
          if (wIdx === -1 && !globalWorker) {
              alert("Please either Select a Worker from the dropdown OR map a Worker Column!");
              return;
          }
          
          document.getElementById("excelPreviewModal").style.display = "none";
          document.getElementById("loading-worker").style.display = "flex";
          
          let records = [];
          let skipped = 0;
          
          parsedExcelData.forEach(item => {
              const row = item._rawRow;
              
              // Get Worker Name
              let wName = globalWorker;
              if (wIdx !== -1 && row[wIdx]) {
                  wName = String(row[wIdx]).trim();
              }
              
              if (!wName) {
                  skipped++;
                  return; 
              }
              
              // Get Date
              let dateStr = parseExcelDateSafe(row[dIdx]);
              // Basic date validation YYYY-MM-DD
              if (!dateStr || dateStr.length !== 10) {
                   // Try to see if it's already ISO string or fallback? handled by parseExcelDateSafe returning val
                   // We strict check if it matches YYYY-MM-DD
                   if (!/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                       skipped++;
                       return;
                   }
              }
              
              // Get Amount
              let amount = parseFloat(row[aIdx]);
              if (!amount || isNaN(amount) || amount <= 0) {
                  // Allow 0? usually sales > 0
                  // skipped++; 
                  // Let's skip invalid amounts
                  return;
              }
              
              records.push({
                   entry_date: dateStr,
                   worker_name: wName,
                   amount: amount,
                   discount: 0, 
                   loyalty_discount: 0
               });
          });
          
          if (records.length === 0) {
              alert("No valid records found to import. Check your column mappings.");
              document.getElementById("loading-worker").style.display = "none";
              return;
          }
          
          // Upsert to cloud
         const { error } = await supabaseClient
          .from("sales_records")
          .upsert(records, { onConflict: "entry_date, worker_name" });

         if (error) {
           alert("Import Error: " + error.message);
         } else {
           showToast(`Imported ${records.length} entries! (${skipped} skipped)`);
           
           // Update cache (optimized)
           records.forEach(r => {
             if (!cloudCache[r.entry_date]) cloudCache[r.entry_date] = { incomes: {}, discount: 0, loyalty: 0 };
             cloudCache[r.entry_date].incomes[r.worker_name] = r.amount;
           });
           
           // Refresh View
           if (document.getElementById("tabWorker").classList.contains("active")) {
               loadWorkerBatch();
           }
         }
         
         document.getElementById("loading-worker").style.display = "none";
      }

      let ytdData = [];
      async function generateReportFromSummary() {
        await prefetchPeriodData();
        // Fetch YTD (Start of Year to end of current period)
        const yearStart = "2026-01-01";
        const periodEnd = currentPeriodDates[currentPeriodDates.length - 1];
        const { data, error } = await supabaseClient
          .from("sales_records")
          .select("*")
          .gte("entry_date", yearStart)
          .lte("entry_date", periodEnd);
        ytdData = data || [];
        generateReport();
      }

      const fmt = (num) =>
        new Intl.NumberFormat("en-US", {
          style: "currency",
          currency: "USD",
          maximumFractionDigits: 0,
        }).format(num);

       function generateReport() {
        if (!currentPeriodDates.length) return;
        const body = document.getElementById("summaryBody");
        body.innerHTML = "";
        
        const statsBody = document.getElementById("workerStatsBody");
        if (statsBody) statsBody.innerHTML = "";
        
        let tableYtdPaySum = 0;

        workers.forEach((w) => {
          let s = 0,
            d = 0;
          currentPeriodDates.forEach((date) => {
            let entry = cloudCache[date] || {
              incomes: {},
              discount: 0,
              loyalty: 0,
            };
            let inc = entry.incomes[w] || 0;
            s += inc;
            if (inc > 0) d++;
          });

          // Commission Logic: 55% Gross (Kim is 0)
          let isKim = w.toLowerCase() === "kim";
          let isLinh = w.toLowerCase() === "linh";
          let pay = isKim ? 0 : Math.round(s * SERVICE_RATE);

          // W2 Logic: Tuyen(Bella)/Thuy(Lee) $750, Others $700, Kim $2500, Linh 100%
          let is750 = ["tuyen (bella)", "thuy (lee)"].includes(w.toLowerCase());

          let defaultW2 = 0;
          if (s > 0) {
            if (isKim) defaultW2 = 2500;
            else if (isLinh) defaultW2 = pay;
            else if (is750) defaultW2 = 750;
            else defaultW2 = 700;
          }

          // YTD Stats for Worker
          let ySales = 0;
          let yDaysSet = new Set();
          ytdData.forEach((r) => {
            if (r.worker_name === w) {
              let amt = parseFloat(r.amount) || 0;
              if (amt > 0) {
                ySales += amt;
                yDaysSet.add(r.entry_date);
              }
            }
          });
          let yDays = yDaysSet.size;
          let yPay = isKim ? 0 : Math.round(ySales * SERVICE_RATE);
          if(!isKim) tableYtdPaySum += yPay;

          let avg = d > 0 ? pay / d : 0;
          let yAvg = yDays > 0 ? yPay / yDays : 0;

          let tr = document.createElement("tr");
          tr.dataset.workerName = w; // Store raw name for logic
          tr.innerHTML = `<td style="font-weight:700;">${w}</td>
        <td style="text-align:right;">${fmt(s)}</td>
        <td style="text-align:right;">${d}</td>
        <td style="text-align:right; font-weight:700; color:var(--secondary);">${fmt(
          pay
        )}</td>
        <td style="text-align:right;">
          <div style="display:inline-flex; align-items:center; background:white; border:1px solid var(--border); border-radius:8px; padding:0 4px;">
            <span style="font-size:12px; color:var(--text-muted); margin-right:2px;">$</span>
            <input type="number" class="w2-entry" value="${Math.round(
              defaultW2
            )}" style="width:70px; text-align:right; border:none; outline:none; padding:4px 2px;" oninput="updateFoot()">
          </div>
        </td>
        <td style="text-align:right; font-weight:700; color:var(--success);" class="c-cell">${fmt(
          0
        )}</td>`;
          body.appendChild(tr);

          // Populate the new stats table
          if (statsBody && !isKim) {
             let trStat = document.createElement("tr");
             trStat.style.borderBottom = "1px solid rgba(0,0,0,0.05)";
             trStat.innerHTML = `
                <td style="padding: 6px 4px; font-weight: 700;">${w}</td>
                <td style="padding: 6px 4px; text-align: right;">${fmt(ySales)}</td>
                <td style="padding: 6px 4px; text-align: right;">${fmt(avg)}</td>
                <td style="padding: 6px 4px; text-align: right; color:var(--secondary); font-weight:700;">${fmt(yPay)}</td>
                <td style="padding: 6px 4px; text-align: right;">${fmt(yAvg)}</td>
             `;
             statsBody.appendChild(trStat);
          }
        });
        
        updateFoot();
        document.getElementById("summarySection").style.display = "block";
        document
          .getElementById("summarySection")
          .scrollIntoView({ behavior: "smooth" });
      }

      function updateFoot() {
        let grossTot = 0,
          daysTot = 0,
          payTot = 0,
          w2Tot = 0,
          cashTot = 0,
          discTot = 0;

        // Calc total biweekly discounts across all dates
        currentPeriodDates.forEach((date) => {
          let entry = cloudCache[date] || { discount: 0, loyalty: 0 };
          discTot +=
            (parseFloat(entry.discount) || 0) +
            (parseFloat(entry.loyalty) || 0);
        });

        Array.from(document.getElementById("summaryBody").rows).forEach((r) => {
          let wName = r.dataset.workerName || "";
          grossTot +=
            parseFloat(r.cells[1].textContent.replace(/[^0-9.-]+/g, "")) || 0;
          daysTot += parseInt(r.cells[2].textContent) || 0;
          let pay =
            parseFloat(r.cells[3].textContent.replace(/[^0-9.-]+/g, "")) || 0;

          // Exclude Kim from Staff Pay total
          if (wName.toLowerCase() !== "kim") {
            payTot += pay;
          }

          let w2 = parseFloat(r.querySelector(".w2-entry").value) || 0;
          w2Tot += w2;
          let cash = Math.max(0, pay - w2);
          r.querySelector(".c-cell").textContent = fmt(cash);
          cashTot += cash;
        }); // End Row Loop

        let finGrossSale = Math.round(grossTot - discTot);
        let finNetSale = Math.round(finGrossSale - payTot);

        // Shop Period Avg
        let shopAvg = daysTot > 0 ? payTot / daysTot : 0;

        document.getElementById("totGross").textContent = fmt(grossTot);
        document.getElementById("totDays").textContent = daysTot;
        document.getElementById("totPay").textContent = fmt(payTot);
        document.getElementById("totW2").textContent = fmt(w2Tot);
        document.getElementById("totCash").textContent = fmt(cashTot);

        // YTD Total Calculation (Summing Finalized Pay Periods)
        let ytdGross = 0,
          ytdDisc = 0,
          ytdPay = 0;
        let ytdManDays = 0; // Total days worked across all staff all year

        // 1. Identify current period index
        const sd = new Date(periodStart + "T00:00:00");
        const currentPIdx = Math.floor(
          (sd - ANCHOR_DATE) / (1000 * 60 * 60 * 24 * 14)
        );

        // 2. Group HISTORICAL YTD data into 14-day Pay Period buckets
        let periods = {};
        ytdData.forEach((row) => {
          const d = new Date(row.entry_date + "T00:00:00");
          const daysSince = Math.floor(
            (d - ANCHOR_DATE) / (1000 * 60 * 60 * 24)
          );
          const pIdx = Math.floor(daysSince / 14);

          // Only process periods BEFORE the current one
          if (pIdx >= 0 && pIdx < currentPIdx) {
            if (!periods[pIdx])
              periods[pIdx] = { records: [], days: new Set() };
            periods[pIdx].records.push(row);
            periods[pIdx].days.add(row.entry_date);
          }
        });

        // 3. Sum up historical periods
        Object.keys(periods).forEach((pIdx) => {
          let p = periods[pIdx];
          let pGross = 0,
            pDisc = 0,
            pPay = 0;
          let pWorkerSums = {};
          let pDaysSeen = new Set();

          p.records.forEach((r) => {
            let amt = parseFloat(r.amount) || 0;
            pGross += amt;
            pWorkerSums[r.worker_name] =
              (pWorkerSums[r.worker_name] || 0) + amt;
            if (!pDaysSeen.has(r.entry_date)) {
              pDisc +=
                (parseFloat(r.discount) || 0) +
                (parseFloat(r.loyalty_discount) || 0);
              pDaysSeen.add(r.entry_date);
            }
          });

            Object.keys(pWorkerSums).forEach((w) => {
            if (w.toLowerCase() !== "kim") {
              pPay += Math.round(pWorkerSums[w] * SERVICE_RATE);
            }
          });

          // Count Man-Days in this period
          p.records.forEach((r) => {
            let amt = parseFloat(r.amount) || 0;
            if (amt > 0) ytdManDays++;
          });

          ytdGross += pGross;
          ytdDisc += pDisc;
          ytdPay += pPay;
        });

        // 4. Add CURRENT Biweekly finalized totals to get YTD TOTAL
        ytdGross += grossTot;
        ytdDisc += discTot;
        ytdPay += payTot;
        ytdManDays += daysTot;

        let shopYtdAvg = ytdManDays > 0 ? ytdPay / ytdManDays : 0;

        let ytdGrossSale = Math.round(ytdGross - ytdDisc);
        let ytdNetSale = Math.round(ytdGrossSale - ytdPay);

        document.getElementById("finTotalSale").textContent = fmt(grossTot);
        document.getElementById("finDiscounts").textContent = fmt(discTot);
        document.getElementById("finGrossSale").textContent = fmt(finGrossSale);
        document.getElementById("finTotalPay").textContent = fmt(payTot);
        // document.getElementById("finAvgPay").textContent = fmt(shopAvg); // Removed
        document.getElementById("finNetSale").textContent = fmt(finNetSale);

        document.getElementById("ytdTotalSale").textContent = fmt(ytdGross);
        document.getElementById("ytdDiscounts").textContent = fmt(ytdDisc);
        document.getElementById("ytdGrossSale").textContent = fmt(ytdGrossSale);
        document.getElementById("ytdTotalPay").textContent = fmt(ytdPay);
        // document.getElementById("ytdAvgPay").textContent = fmt(shopYtdAvg); // Removed
        document.getElementById("ytdNetSale").textContent = fmt(ytdNetSale);

        // Annual Projections (26 periods per year)
        document.getElementById("finAnnualSales").textContent = fmt(
          grossTot * 26
        );
        document.getElementById("finAnnualNet").textContent = fmt(
          finNetSale * 26
        );
      }

      function showToast(m) {
        let t = document.getElementById("toast");
        t.textContent = m;
        t.style.opacity = "1";
        setTimeout(() => (t.style.opacity = "0"), 3000);
      }
    </script>
  </body>
</html>
